<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="dealtypeM">
	<!-- 获取交易类型信息 -->
	<select id="getDealType" resultClass="DealTypeManageBean" parameterClass="java.util.Map">
		  SELECT  
				dt.DT_ID AS dealTypeId,
				dt.SERVDODE AS serverCode,
				dt.TRADECODE AS tradeCode,
				dt.DT_NAME AS dealTypeName,
				GETDEALTYPECOUNTBYID(dt.DT_NAME) AS dealCount,
				dt.DT_STATUS AS dealTypeStatus,
	  CASE WHEN dt.DT_STATUS='1' THEN '有效' ELSE '无效' END AS dealTypeStatusStr,
				dt.DT_DESC AS dealTypeDesc,
		 		getUserNameById(dt.CREATEID) as createrId,
				dt.CREATEDT AS createDate
				<!-- dt.SYSTEMID AS systemId  
				GETSYSTEMNAMEBYID(dt.SYSTEMID) as systemName-->
		   FROM QT1TBLDEALTYPE dt
		  WHERE 1=1
		  <!--  14.10.31 需求变，不再使用systemId
			<isNotEmpty property="systemId">
			AND dt.SYSTEMID=#systemId#
			 </isNotEmpty>
		 -->
		<isNotEmpty property="status">
			AND dt.DT_STATUS=#status#
		 </isNotEmpty>
		 <isNotEmpty property="dealTypeName">
			AND dt.DT_NAME LIKE
			'%$dealTypeName$%'
		</isNotEmpty>
		order by dt.CREATEDT desc
	</select>
	
	<!-- 获得所有有效的交易类型（下拉框使用）(与选中的机构有关) -->
	<select id="getCombDealTypesByagencyId" resultClass="DealTypeManageBean" parameterClass="java.util.Map">
			 SELECT
			    dt.DT_ID AS dealTypeId ,
			    dt.DT_NAME AS dealTypeName
			FROM
			    QT1TBLDEALTYPE dt
			WHERE
			    dt.DT_STATUS = '1'
			    <!-- 交易类型不再区分来源系统，数据库中对应字段已删除 20141110
			    	AND dt.SYSTEMID IN(
			        SELECT
			            A.SYSTEMID
			        FROM
			            rtb_qt1tblagency A
			        WHERE
			            A.AGENCY_ID = #agencyId#
			        )
			     -->

    </select>
    
    <!-- 14.11.03新需求 
    	获得所有有效的交易类型（下拉框使用）（获取所有） -->
	<select id="getCombDealTypesAll" resultClass="DealTypeManageBean" parameterClass="java.util.Map">
			 SELECT
			    dt.DT_ID AS dealTypeId ,
			    dt.DT_NAME AS dealTypeName
			FROM
			    QT1TBLDEALTYPE dt
			WHERE
			    dt.DT_STATUS = '1'
	 </select>
    
    
	<select id="getCombDealTypes" resultClass="DealTypeManageBean" parameterClass="java.util.Map">
			  SELECT  
					dt.DT_ID AS dealTypeId,
					dt.DT_NAME AS dealTypeName
			   FROM QT1TBLDEALTYPE dt
			  WHERE dt.DT_STATUS='1'
			  <!-- 交易类型不再区分来源系统，数据库中对应字段已删除 20141110
			  <isNotEmpty property="systemId">
			  and dt.SYSTEMID=#systemId#
			  </isNotEmpty>
			   -->
	</select>
	
	<!-- 添加交易类型 -->
	 <insert id="addDealType" parameterClass="DealTypeManageBean">
		INSERT INTO QT1TBLDEALTYPE(
				DT_ID,
				DT_NAME,
				DT_STATUS,
				DT_DESC,
				CREATEID,
				CREATEDT,
				<!-- 14.10.31 需求修改，加入服务编码，渠道编码，删除来源系统 -->
				SERVDODE,
				TRADECODE
			  )
		VALUES(
				#dealTypeId#,
				#dealTypeName#,
				#dealTypeStatus#,
				#dealTypeDesc#,
				#createrId#,
				#createDate#,
				<!-- 14.10.31 需求修改，加入服务编码，渠道编码，删除来源系统 -->
				#serverCode#,
				#tradeCode#
			  )
	</insert>
	
	<!-- 添加交易类型 -->
	<update id="updateDealType" parameterClass="DealTypeManageBean">
		UPDATE
		QT1TBLDEALTYPE SET
			DT_NAME =#dealTypeName#,
			DT_STATUS=#dealTypeStatus#,
			DT_DESC=#dealTypeDesc#,
			<!-- 14.10.31 需求修改，加入服务编码，渠道编码，删除来源系统 -->
			SERVDODE=#serverCode#,
			TRADECODE=#tradeCode#
		WHERE
		DT_ID=#dealTypeId#
	</update>
	
	<!-- 编辑交易类型 -->
	<update id="deleteDealType" parameterClass="java.lang.String">
		UPDATE
		QT1TBLDEALTYPE SET
		DT_STATUS='0' where DT_ID in($dealTypeIds$)
	</update>
	
	
	<select id="getCombDealTypeByAgencyId" resultClass="DealTypeManageBean" parameterClass="java.util.Map">
		  SELECT dt.DT_ID AS dealTypeId, dt.DT_NAME AS dealTypeName
			    FROM QT1TBLDEALTYPE dt
			   INNER JOIN (SELECT DISTINCT M.DEAL_TYPE
			                 FROM QT1TBLORGSPLITTMPT M
			                WHERE   M.MOULD_NAME = 'UUUUU'
			                  	<isNotEmpty property="agencyId">
									AND M.AGENCY_ID = #agencyId#
								 </isNotEmpty>
			                  ) S
			      ON DT.DT_ID = S.DEAL_TYPE
			   WHERE dt.DT_STATUS = '1'
			 
	</select>
</sqlMap>