<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="AgencyCost">
	
  <resultMap id="BaseResultMap" class="AgencyCost" >
    <result column="id" property="id" jdbcType="VARCHAR" />
    <result column="AGENCY_ID" property="agencyId" jdbcType="VARCHAR" />
    <result column="COST_RATE" property="costRate" jdbcType="DECIMAL" />
    <result column="COST_FIX" property="costFix" jdbcType="DECIMAL" />
    <result column="CREATEDT" property="createdt" jdbcType="VARCHAR" />
    <result column="BUSINESS_TYPE" property="businessType" jdbcType="VARCHAR" />
    <result column="OPERDT" property="operdt" jdbcType="VARCHAR" />
    <result column="OPER" property="oper" jdbcType="VARCHAR" />
    <result column="COMPANYNAME" property="agencyName" jdbcType="VARCHAR" />
  </resultMap>
  
   <resultMap id="CostGroupMap" class="AgencyCost" >
    <result column="row_id" property="id" jdbcType="VARCHAR" />
    <result column="AGENCY_ID" property="agencyId" jdbcType="VARCHAR" />
    <result column="operdt" property="operdt" jdbcType="VARCHAR" />
    <result column="OPER" property="oper" jdbcType="VARCHAR" />
    <result column="status" property="status" jdbcType="VARCHAR" />
    <result column="COMPANYNAME" property="agencyName" jdbcType="VARCHAR" />
    <result column="opername" property="operName" jdbcType="VARCHAR" />
  </resultMap>
 	 
 	 
  <resultMap id="CostProductTypeMap" class="AgencyCost" >
    <result column="id" property="id" jdbcType="VARCHAR" />
    <result column="AGENCY_ID" property="agencyId" jdbcType="VARCHAR" />
    <result column="COST_RATE" property="costRate" jdbcType="DECIMAL" />
    <result column="COST_FIX" property="costFix" jdbcType="DECIMAL" />
    <result column="CREATEDT" property="createdt" jdbcType="VARCHAR" />
    <result column="BUSINESS_TYPE" property="businessType" jdbcType="VARCHAR" />
    <result column="OPERDT" property="operdt" jdbcType="VARCHAR" />
    <result column="OPER" property="oper" jdbcType="VARCHAR" />
    <result column="productdesc" property="businessTypeName" jdbcType="VARCHAR" />
  </resultMap>
  
  <resultMap id="costDetailMap" class="AgencyCost" >
    <result column="id" property="id" jdbcType="VARCHAR" />
    <result column="AGENCY_ID" property="agencyId" jdbcType="VARCHAR" />
    <result column="COST_RATE" property="costRate" jdbcType="DECIMAL" />
    <result column="COST_FIX" property="costFix" jdbcType="DECIMAL" />
    <result column="CREATEDT" property="createdt" jdbcType="VARCHAR" />
    <result column="productdesc" property="businessTypeName" jdbcType="VARCHAR" />
    <result column="OPERDT" property="operdt" jdbcType="VARCHAR" />
    <result column="OPER" property="oper" jdbcType="VARCHAR" />
    <result column="COMPANYNAME" property="agencyName" jdbcType="VARCHAR" />
    <result column="username" property="operName" jdbcType="VARCHAR" />
    <result column="status" property="status" jdbcType="VARCHAR" />
  </resultMap>
 	 
 	 
 	 
  <sql id="Base_Column_List" >
   ID, t1.AGENCY_ID, COST_RATE, COST_FIX, CREATEDT, BUSINESS_TYPE, OPERDT, OPER, COMPANYNAME
  </sql>
  
  
   
   <!-- 机构分润成本查询 -->
   <select id="selectAllAgencyCostGroup" resultMap="CostGroupMap" parameterClass="map">
	with tt as(
		select t2.agency_id,t2.operdt,t2.oper,'1' status from rtb_agency_cost t2 
		left join rtb_qt1tblagency a on  a.agency_id = t2.agency_id 
	<dynamic prepend="WHERE">  
        <isNotNull prepend="AND" property="agency_id">   
                       t2.AGENCY_ID = #agency_id#     
        </isNotNull>  
        <isNotNull prepend="AND" property="onlinechannel">   
                      a.onlinechannel = #onlinechannel#
        </isNotNull>  
	</dynamic>
		 group by t2.agency_id,t2.operdt,t2.oper
	) 
	select * from ( select tmp_page.*, rownum row_id from ( 
	select tt.*,a.companyname,u.username operName from tt left join rtb_qt1tblagency a on  a.agency_id = tt.agency_id
	left join users u on u.userid = tt.oper
    <dynamic prepend="WHERE">  
        <isNotNull prepend="AND" property="agency_id">   
                       tt.AGENCY_ID = #agency_id#     
        </isNotNull>  
        <isNotNull prepend="AND" property="onlinechannel">   
                      a.onlinechannel = #onlinechannel#
        </isNotNull>  
         <isNotEmpty prepend="AND" property="status">   
                      tt.status = #status#
        </isNotEmpty>  
	</dynamic>
	) tmp_page where rownum <![CDATA[ <= #end# ]]>  ) where row_id <![CDATA[  > #start# ]]>
  </select>
  
  
   <!-- 机构分润成本查询 -->
   <select id="selectAgencyCostCountGroup" resultClass="int" parameterClass="map">
   with tt as(
		select t2.agency_id,t2.operdt,t2.oper,'1' status from rtb_agency_cost t2  
		left join rtb_qt1tblagency a on  a.agency_id = t2.agency_id 
	<dynamic prepend="WHERE">  
        <isNotNull prepend="AND" property="agency_id">   
                       t2.AGENCY_ID = #agency_id#     
        </isNotNull>  
        <isNotNull prepend="AND" property="onlinechannel">   
                      a.onlinechannel = #onlinechannel#
        </isNotNull>  
	</dynamic>
		 group by t2.agency_id,t2.operdt,t2.oper
	) 
	select count(*) from tt left join rtb_qt1tblagency a on  a.agency_id = tt.agency_id
	left join users u on u.userid = tt.oper
    <dynamic prepend="WHERE">  
        <isNotNull prepend="AND" property="agency_id">   
                       tt.AGENCY_ID = #agency_id#     
        </isNotNull>  
        <isNotNull prepend="AND" property="onlinechannel">   
                      a.onlinechannel = #onlinechannel#
        </isNotNull>  
         <isNotEmpty prepend="AND" property="status">   
                      tt.status = #status#
        </isNotEmpty>  
	</dynamic>
   </select>
   
   
   
    <select id="selectAllAgencyCost" resultMap="BaseResultMap" parameterClass="map">
    select * from ( select tmp_page.*, rownum row_id from ( 
    select
    <include refid="Base_Column_List" />
    from (select t.agency_id,COMPANYNAME from rtb_qt1tblagency t where t.onlinechannel =#agencyIdRoot#
	) t1 left join rtb_agency_cost t2 on t1.agency_id=t2.agency_id
    <dynamic prepend="WHERE">  
        <isNotNull prepend="AND" property="agency_id">   
                        t2.AGENCY_ID = #agency_id#     
        </isNotNull>  
	</dynamic>
	<isNotNull property="orderByClause">
	      order by #orderByClause#
	</isNotNull>
	) tmp_page where rownum <![CDATA[ <= #end# ]]>  ) where row_id <![CDATA[  > #start# ]]>
  </select>
  
  
  <select id="getAllPayproduct" resultClass="com.compass.agencyCost.model.Payproduct">
  	select	p.productdesc, p.rtb_Type rtbType from qtpay.payproduct p where p.rtb_type  is not null  order by rtb_type asc
  </select>
  
  <select id="getPayproductDesc" resultClass="string" parameterClass="string">
  	select distinct	p.productdesc from qtpay.payproduct p where  p.rtb_type = #rtbType#
  </select>
  
  <!-- 查询机构生效中的记录 -->
  <select id="selectisUseAgencyCost" parameterClass="string" resultMap="CostProductTypeMap">
	 select c.*,p.productdesc from rtb_agency_cost c left join 
	 qtpay.payproduct p on p.rtb_type = c.business_type
	where c.agency_id =  #agencyId#  order by c.business_type  asc
  </select>
  
  <!-- 查询待生效详情记录 -->
  <select id="queryRegCostDetail" parameterClass="string" resultMap="costDetailMap">
  	select c.*,p.productdesc,u.username,'待生效' status, q.companyname from rtb_agency_cost c 
	left join qtpay.payproduct p on p.rtb_type = c.business_type 
	left join users u on u.userid = c.oper 
	left join rtb_qt1tblagency q on q.agency_id = c.agency_id
	where c.agency_id = #agencyId# 
  </select>
  
  
    <!-- 查询生效详情记录 -->
  <select id="queryCostDetail" parameterClass="string" resultMap="costDetailMap">
  	select c.*,p.productdesc,u.username,'生效中' status, q.companyname from rtb_agency_cost c 
	left join qtpay.payproduct p on p.rtb_type = c.business_type 
	left join users u on u.userid = c.oper 
	left join rtb_qt1tblagency q on q.agency_id = c.agency_id
	where c.agency_id = #agencyId# 
  </select>
  
  
   <!-- 设置生效中的费率 -->
   <insert id="insertIsUser" parameterClass="AgencyCost" >
    insert into RTB_AGENCY_COST (ID, AGENCY_ID, COST_RATE, 
      COST_FIX, CREATEDT, BUSINESS_TYPE, 
      OPERDT, OPER)
    values (seq_rtbAgencyCostReg.Nextval, #agencyId#, #costRate#, #costFix#, #createdt#, #businessType#, 
      #operdt#, #oper#)
  </insert>
  
  
  <!-- 根据机构Id删除生效的费率 -->
  <delete id="deleteIsUseWithAgencyId" parameterClass="string">
  	delete from rtb_agency_cost r where  r.agency_id = #agencyId# 
  </delete>
  
  
  <!-- 插入log日志 -->
  <insert id="insertCostLog" parameterClass="com.compass.agencyCost.model.AgencyCostLog" >
    insert into RTB_AGENCY_COST_LOG (FID, ID, AGENCY_ID, 
      COST_RATE, COST_FIX, CREATEDT, 
      INDATE, BUSINESS_TYPE, OPERDT, OPER)
    values (#fid#, #id#, #agencyId#, #costRate#, #costFix#, #createdt#, 
      #indate#, #businessType#, #operdt#, #oper#)
  </insert>

	<!-- 查询费率对象 -->
	<select id="queryAgencyCostObj" resultMap="BaseResultMap" parameterClass="map">
	     select * from rtb_agency_cost c where c.agency_id =#agencyId# and c.business_type= #businessType# 
	</select>
	
	
	<!-- 查询生效中的费率 -->
	<select id="queryCostRate" resultClass="java.math.BigDecimal" parameterClass="map">
		select c.cost_rate from rtb_agency_cost c where c.agency_id =#agencyId# and c.business_type= #businessType# 
	</select>
	
   <!-- 查询生效中的固定值-->
	<select id="queryCostFix" resultClass="java.math.BigDecimal" parameterClass="map">
		select c.cost_fix from rtb_agency_cost c where c.agency_id =#agencyId# and c.business_type= #businessType# 
	</select>
	
	<!-- 代理商成本费率值 -->
	<select id="queryCostRateBase" resultClass="java.math.BigDecimal" parameterClass="string">
		select pm_value from rtb_paramter where pm_no = #pm_no#
	</select>
	
	<!-- 更新成本费率 -->
   <update id="updateAgencyCost" parameterClass="AgencyCost" >
    update RTB_AGENCY_COST
    <dynamic prepend="set" >
      <isNotNull prepend="," property="costRate" >
        COST_RATE = #costRate:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="costFix" >
        COST_FIX = #costFix:DECIMAL#
      </isNotNull>
      <isNotNull prepend="," property="createdt" >
        CREATEDT = #createdt:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="operdt" >
        OPERDT = #operdt:VARCHAR#
      </isNotNull>
      <isNotNull prepend="," property="oper" >
        OPER = #oper:VARCHAR#
      </isNotNull>
    </dynamic>
    where  AGENCY_ID = #agencyId:VARCHAR# and   BUSINESS_TYPE = #businessType:VARCHAR#
  </update>
  
  <update id="updateAgencyCostTimes">
   	update RTB_AGENCY_COST set updateTimes = 0 
  </update>
  
</sqlMap>
