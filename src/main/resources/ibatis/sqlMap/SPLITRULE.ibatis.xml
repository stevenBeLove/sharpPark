<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="rule">
	<!-- 获得分润规则信息 -->
	<select id="getRules" resultClass="SplitRuleBean" parameterClass="java.util.Map">
		  SELECT
		      DISTINCT
		      AGENCY_ID AS agencyId,
		      CHILD_AGENCY_ID AS childAgencyId,
		      getAgencyNameById(CHILD_AGENCY_ID) AS childAgencyName,
		      DEAL_TYPE AS dealType,
		      GETDEALTYPENAMEBYID(DEAL_TYPE) AS dealTypeName,
		      SPLITTING_MODE AS splittingMode,
		      CASE WHEN SPLITTING_MODE='1' THEN '按总笔数分润' WHEN SPLITTING_MODE='2' THEN '按总金额分润'  ELSE '按收益分润' END AS splittingModeStr,
		      SCALE AS scale,
		      CASE WHEN SCALE='1' THEN '总笔数' ELSE '总金额' END AS scaleStr,
		      VALIDITY_DATA AS validityData,
		      getUserNameById(CREATERID) as createrId,
		      CREATEDATE AS createDate
		    FROM    QT1TBLPROFITSRULES 
		    WHERE  AGENCY_ID = #agencyId#
		<isNotEmpty property="childagencyId">
				AND  CHILD_AGENCY_ID=#childagencyId#
		</isNotEmpty>
		
	</select>
	<!-- 根据相应条件获取规则编号 -->
	<select id="checkrule" resultClass="SplitRuleBean" parameterClass="java.util.Map">
		 	SELECT
		      RULE_ID AS ruleId
		    FROM QT1TBLPROFITSRULES T
		   WHERE T.AGENCY_ID = #agencyId#
			 AND T.CHILD_AGENCY_ID = #childAgencyId#
			 AND T.Deal_Type =#dealType#
			 AND T.VALIDITY_DATA =#validityData#
	</select>
	
	<!-- 获得交易规模区间 -->
	<select id="getRulesByIds" resultClass="SplitRuleBean" parameterClass="java.util.Map">
		SELECT T.RULE_ID AS ruleId, 
			   T.SCALE_STARTVALUE AS scaleStartValue, 
			   T.SCALE_ENDVALUE  AS scaleEndValue
		   FROM QT1TBLPROFITSRULES T
		   WHERE T.AGENCY_ID = #agencyId#
			 AND T.CHILD_AGENCY_ID = #childAgencyId#
			 AND T.Deal_Type =#dealType#
			 order by T.SCALE_STARTVALUE
	</select>
	
	<!--  获取单笔区间 -->
	<select id="getSingleDealSection" resultClass="SplitRuleBean" parameterClass="java.lang.String">
		SELECT SINGLE_RULE_ID AS singleRuleId,
		       RULE_ID AS ruleId,
		       SINGLE_DEAL_STARTVALUE AS singleDealStartValue,
		       SINGLE_DEAL_ENDVALUE AS singleDealEndValue,
		       RATE AS rate
		  FROM QT1TBLPROFITSRULESINGLE
		 WHERE  RULE_ID = #ruleId#
		 order by SINGLE_DEAL_STARTVALUE
	</select>
	
	<!-- 添加分润规则 -->
	 <insert id="addRule" parameterClass="SplitRuleBean">
	INSERT INTO QT1TBLPROFITSRULES
		  (RULE_ID,
		   CHILD_AGENCY_ID,
		   AGENCY_ID,
		   DEAL_TYPE,
		   SPLITTING_MODE,
		   SCALE,
		   SCALE_STARTVALUE,
		   SCALE_ENDVALUE,
		   VALIDITY_DATA,
		   CREATERID,
		   CREATEDATE)
	  VALUES(
			#ruleId#,
			#childAgencyId#,
			#agencyId#,
			#dealType#,
			#splittingMode#,
			#scale#,
			#scaleStartValue#,
			#scaleEndValue#,
			#validityData#,
			#createrId#,
			#createDate#
			)
	</insert>
	<update id="updateRule" parameterClass="SplitRuleBean">
		update QT1TBLPROFITSRULES 
		set DEAL_TYPE=#dealType#,
		   SPLITTING_MODE=#splittingMode#,
		   SCALE=#scale#,
		   SCALE_STARTVALUE=#scaleStartValue#,
		   SCALE_ENDVALUE=#scaleEndValue#,
		   VALIDITY_DATA=#validityData#,
		   CREATERID=#createrId#,
		   CREATEDATE=#createDate#
		   where RULE_ID=#ruleId#
	</update>
	<delete id="delRule" parameterClass="java.util.Map">
		delete from QT1TBLPROFITSRULES where RULE_ID=#ruleId#
	</delete>
	
	<!-- 删除分润规则-->
	<delete id="deleteRules" parameterClass="java.util.Map">
		DELETE FROM  QT1TBLPROFITSRULES  T
			 WHERE T.AGENCY_ID = #agencyId#
			 AND T.CHILD_AGENCY_ID = #childAgencyId#
			 AND T.Deal_Type =#dealType#
			 AND T.VALIDITY_DATA = #validityData#
	</delete>
	
	<!-- 添加单笔区间 -->
	 <insert id="addSingleRule" parameterClass="SplitRuleBean">
		INSERT INTO QT1TBLPROFITSRULESINGLE
			(
			 SINGLE_RULE_ID,
			 RULE_ID,
			 SINGLE_DEAL_STARTVALUE,
			 SINGLE_DEAL_ENDVALUE,
			 RATE,
			 CREATERID,
			 CREATEDATE
			)
	  VALUES(
	  		#singleRuleId#,
			#ruleId#,
			#singleDealStartValue#,
			#singleDealEndValue#,
			#rate#,
			#createrId#,
			#createDate#
			)
	</insert>
	
	<!--根据交易规模区间删除单笔区间-->
	<delete id="deleteSingleRules" parameterClass="java.lang.String">
		DELETE FROM  QT1TBLPROFITSRULESINGLE WHERE RULE_ID =#ruleId#
	</delete>
	<select id="getRulesCount" parameterClass="java.util.Map" resultClass="java.lang.Integer">
		SELECT
		    COUNT(1)
		FROM
		    (
		        SELECT
		             DISTINCT AGENCY_ID ,
		            CHILD_AGENCY_ID ,
		            DEAL_TYPE,
		            SPLITTING_MODE,
		            SCALE
		        FROM
		            QT1TBLPROFITSRULES
		        where AGENCY_ID=#agencyId#
		        and CHILD_AGENCY_ID=#childAgencyId#
		        and DEAL_TYPE=#dealType#
		    )
	</select>
	
</sqlMap>