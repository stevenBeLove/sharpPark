<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="QueryTradeProfit">


 <resultMap id="ProfitResultMap" class="com.compass.pasmFee.model.TradeProfit" >
    <result column="FRID" property="frid" jdbcType="VARCHAR" />
    <result column="SERVCODE" property="servcode" jdbcType="VARCHAR" />
    <result column="LOCALDATE" property="localdate" jdbcType="VARCHAR" />
    <result column="LOCALTIME" property="localtime" jdbcType="VARCHAR" />
    <result column="LOCALLOGNO" property="locallogno" jdbcType="VARCHAR" />
    <result column="MERCHANTID" property="merchantid" jdbcType="VARCHAR" />
    <result column="PRODUCTID" property="productid" jdbcType="VARCHAR" />
    <result column="ORDERID" property="orderid" jdbcType="VARCHAR" />
    <result column="BUSINESS_TYPE" property="businessType" jdbcType="VARCHAR" />
    <result column="TERMID" property="termid" jdbcType="VARCHAR" />
    <result column="PSAMID" property="psamid" jdbcType="VARCHAR" />
    <result column="AMOUNT" property="amount" jdbcType="VARCHAR" />
    <result column="AGENCY_ID" property="agencyId" jdbcType="VARCHAR" />
    <result column="SUPER_AGENCY_ID" property="superAgencyId" jdbcType="VARCHAR" />
    <result column="SHOPNO" property="shopno" jdbcType="VARCHAR" />
    <result column="FEERATE" property="feerate" jdbcType="DECIMAL" />
    <result column="FIX_FEE" property="fixFee" jdbcType="DECIMAL" />
    <result column="COST_RATE" property="costRate" jdbcType="DECIMAL" />
    <result column="COST_FIX" property="costFix" jdbcType="DECIMAL" />
    <result column="DIFFER_RATE" property="differRate" jdbcType="DECIMAL" />
    <result column="DIFFER_COST_FIX" property="differCostFix" jdbcType="DECIMAL" />
    <result column="FR_AMOUNT" property="frAmount" jdbcType="DECIMAL" />
    <result column="RTBFEE" property="rtbfee" jdbcType="VARCHAR" />
    <result column="STATUS" property="status" jdbcType="VARCHAR" />
    <result column="agencyName" property="agencyName" jdbcType="VARCHAR" />
    <result column="businessName" property="businessName" jdbcType="VARCHAR" />
    <result column="CHILDCOSTRATE" property="childCostRate" jdbcType="DECIMAL" />
    <result column="CHILDCOSTFIX" property="childCostFix" jdbcType="DECIMAL" />
    <result column="CHILDAMOUNT" property="childAmount" jdbcType="DECIMAL" />
    <result column="CHILD_AGENCY_ID" property="childAgencyId" jdbcType="VARCHAR" />
    <result column="MOBILENO" property="mobileNo" jdbcType="VARCHAR"/>
    <result column="sumAmount" property="sumAmount" jdbcType="DECIMAL" />
  </resultMap>
  
  
   <sql id="profit_Column_List" >
    getagencynamebyid(nvl(child_agency_id,agency_id)) agencyName, d.productdesc businessName, FRID, SERVCODE, 
    to_char(to_date(localdate,'yyyy-mm-dd'), 'yyyy-mm-dd') as LOCALDATE, to_char(to_date(localtime,'hh24:mi:ss'),'hh24:mi:ss') as LOCALTIME,
    LOCALLOGNO, f.MERCHANTID, f.PRODUCTID, ORDERID, 
    BUSINESS_TYPE, TERMID, PSAMID, AMOUNT, AGENCY_ID, SUPER_AGENCY_ID, SHOPNO, FEERATE, 
    FIX_FEE, COST_RATE, COST_FIX, DIFFER_RATE, DIFFER_COST_FIX, FR_AMOUNT, RTBFEE, f.STATUS, CHILDCOSTRATE, CHILDCOSTFIX, CHILDAMOUNT, CHILD_AGENCY_ID,
    (nvl(CHILDAMOUNT,0)+nvl(FR_AMOUNT,0)) as sumAmount,MOBILENO
  </sql>
  <!-- where条件 -->
  <sql id="whereClause">
		  <dynamic prepend="WHERE">  
		     	<isNotNull prepend="AND" property="selfAgencyId">   
		                        agency_id = super_agency_id and agency_id = #selfAgencyId#
		        </isNotNull> 
		        
		        <isNotNull prepend="AND" property="adminAgencyId">   
		                     super_agency_id in (select agency_id from rtb_qt1tblagency a where a.onlinechannel = #adminAgencyId#)
		        </isNotNull>
		        
		        <isNotNull prepend="AND" property="superAgencyId">   
		        			super_agency_id = #superAgencyId#
		      	</isNotNull> 
		      	
		      	<isNotNull prepend="AND" property="pageAgencyId">   
		        			CHILD_AGENCY_ID = #pageAgencyId#
		      	</isNotNull> 
		      	
		      	<isNotNull prepend="AND" property="adminPageAgencyId">   
		        			super_agency_id = #adminPageAgencyId#
		      	</isNotNull> 
		      	
		        <isNotEmpty prepend="AND" property="business_name">   
                    <isEqual property="business_name" compareValue="3006">
							d.productdesc like '%云闪付%'
					</isEqual>
                    <isNotEqual property="business_name" compareValue="3006">
                      		BUSINESS_TYPE = #business_name#     
                    </isNotEqual> 
		        </isNotEmpty> 
		        <isNotEmpty prepend="AND" property="logNo">   
		                        f.LOCALLOGNO = #logNo#     
		        </isNotEmpty>
		        <isNotEmpty prepend="AND" property="psamId">   
		                       substr(psamid, 0, 15)  = #psamId# 
		        </isNotEmpty>
		        <isNotEmpty prepend="AND" property="mobileNo">   
                       MOBILENO = #mobileNo#    
        		</isNotEmpty>  
		        <isNotEmpty prepend="AND" property="yearmonthdatestart" >   
		                        LOCALDATE between #yearmonthdatestart# and #yearmonthdateend#    
		        </isNotEmpty>
		        
			</dynamic>
  </sql>
  
  <!-- 查询交易分润明细 -->
  <select id="selectPageTradeProfit" resultMap="ProfitResultMap" parameterClass="java.util.Map">
  	select * from ( select tmp_page.*, rownum row_id from ( 
  	select
    <include refid="profit_Column_List" />
    from RTB_AGENCY_FR_JNLS f left join qtpay.payproduct d on (f.productid = d.productid
    and f.merchantid = d.merchantid)
    <include refid="QueryTradeProfit.whereClause" />
	<isNotNull property="orderByClause">
	      order by $orderByClause$
	</isNotNull>
    ) tmp_page where rownum <![CDATA[ <= #end# ]]>  ) where row_id <![CDATA[  > #start# ]]>
  </select>
  
  <!-- 导出查询交易分润明细 -->
  <select id="selectPageTradeProfitExport" resultMap="ProfitResultMap" parameterClass="java.util.Map">
  	select
    <include refid="profit_Column_List" />
    from RTB_AGENCY_FR_JNLS f left join qtpay.payproduct d on (f.productid = d.productid
    and f.merchantid = d.merchantid)
    <include refid="QueryTradeProfit.whereClause" />
	<isNotNull property="orderByClause">
	      order by $orderByClause$
	</isNotNull>
  </select>
  
  <!-- 查询交易分润明细行数 -->
  <select id="selectPageCountTradeProfit" resultClass="int" parameterClass="java.util.Map">
  	select
    count(*)
    from RTB_AGENCY_FR_JNLS f left join qtpay.payproduct d on (f.productid = d.productid
    and f.merchantid = d.merchantid)
    <include refid="QueryTradeProfit.whereClause" />
  </select>
  
   <!-- 分润总金额 -->
  <select id="queryFee_AmountSumNow" resultClass="String" parameterClass="java.util.Map">
  	select
    sum((nvl(CHILDAMOUNT,0)+nvl(FR_AMOUNT,0)))
    from RTB_AGENCY_FR_JNLS f left join qtpay.payproduct d on (f.productid = d.productid
    and f.merchantid = d.merchantid)
    <include refid="QueryTradeProfit.whereClause" />
   </select>
   
   <!-- 直属下级分润总金额: -->
   <select id="queryNext_feeAmountSumNow" resultClass="String" parameterClass="java.util.Map">
  	select
    sum(CHILDAMOUNT)
    from RTB_AGENCY_FR_JNLS f left join qtpay.payproduct d on (f.productid = d.productid
    and f.merchantid = d.merchantid)
    <include refid="QueryTradeProfit.whereClause" />
   </select>
   
    <!-- 分润差 -->
   <select id="queryDifference_feeAmountSumNow" resultClass="String" parameterClass="java.util.Map">
  	select
    sum(fr_amount)
    from RTB_AGENCY_FR_JNLS f left join qtpay.payproduct d on (f.productid = d.productid
    and f.merchantid = d.merchantid)
    <include refid="QueryTradeProfit.whereClause" />
    
   </select>
   
   <!-- 交易总金额: -->
   <select id="selectDealAmountSum" resultClass="String" parameterClass="java.util.Map">
  	select
    sum(AMOUNT)
    from RTB_AGENCY_FR_JNLS f left join qtpay.payproduct d on (f.productid = d.productid
    and f.merchantid = d.merchantid)
    <include refid="QueryTradeProfit.whereClause" />
   </select>
  
   <!-- 手续费总金额: -->
   <select id="selectPoundageAmountSum" resultClass="String" parameterClass="java.util.Map">
  	select
    sum(RTBFEE)
    from RTB_AGENCY_FR_JNLS f left join qtpay.payproduct d on (f.productid = d.productid
    and f.merchantid = d.merchantid)
    <include refid="QueryTradeProfit.whereClause" />
   </select>
  
   
  

 	<resultMap id="BaseResultMap2" class="QueryTradeProfit" >
    <result column="business_type" property="business_type" jdbcType="VARCHAR" />
    <result column="business_Name" property="business_Name" jdbcType="VARCHAR" />
   </resultMap>	 
 	 
  
  <sql id="Base_Column_List2" >
  	companyname as agency_name, locallogno as logNo , psamId, business_Name, to_char(to_date(localdate,'yyyy-mm-dd'), 'yyyy-mm-dd') as localdate, to_char(to_date(localtime,'hh24:mi:ss'),'hh24:mi:ss') as localtime, (amount/100) as amount, (rtbFee/100) as rtbFee, (feeRate*100) as feeRate, (fix_Fee/100) as fix_Fee, (cost_rate*100) as cost_rate, (cost_fix/100) as cost_fix, '0' as next_FeeRate, '0' as next_FixFee, fr_Amount/100 as fee_Amount, '0' as next_feeAmount, fr_amount/100 as difference_feeAmount
  </sql>
  
    <!-- 交易类型 -->
   <select id="getBusiness" resultMap="BaseResultMap2" parameterClass="java.util.Map">
			  SELECT  
					business_type,
					business_name
			   FROM qtpay.tb_prd_business_type 
			  <dynamic prepend="WHERE">  
				  <isNotEmpty prepend="AND" property="businessName">
						 BUSINESS_SCENARIO = #businessName#
		 	      </isNotEmpty>
		 	  </dynamic>    
	</select>
	
</sqlMap>
