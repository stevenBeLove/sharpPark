<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="fee">

    <resultMap id="terminalCountBeanMap" class="TerminalCountBean">
        <result property="selfCount" column="selfCount"/>
        <result property="selfCountActivity" column="selfCountActi"/>
        <result property="childCount" column="childCount"/>
        <result property="childCountActivity" column="childCountActi"/>
        <result property="agencyId" column="agencyId"/>
        <result property="agencyName" column="agencyName"/>
    </resultMap>
    <parameterMap id="getTerminalCount" class="java.util.HashMap" >
         <parameter property="string" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
         <parameter property="result" jdbcType="ORACLECURSOR" javaType="java.sql.ResultSet" mode="OUT" resultMap="terminalCountBeanMap" />
    </parameterMap>
    <procedure id="SELECTTERMINAL_COUNT" parameterClass="java.util.Map" parameterMap="getTerminalCount" >
         <![CDATA[ call  #guocheng#]]>
    </procedure>
	<resultMap id="beanMap" class="SplitFeeDealType">  
	    <result property="agencyId" column="agencyId"/>  
	    <result property="agnecyName" column="agnecyName"/> 
	    <!--
	    <result property="systemId" column="systemId"/>
	    <result property="systemName" column="systemName"/> 
	    <result property="yearmonth" column="yearmonth"/>
	     -->
	    <result property="dealtype" column="dealtype"/> 
	    <result property="dealtypeStr" column="dealtypeStr"/> 
	    <result property="transCount" column="transCount"/> 
	    <result property="dealCount" column="dealCount"/> 
	    <result property="amount" column="amount"/> 
	</resultMap> 
	
	<resultMap id="splitFeeDealBean" class="SplitFeeDealBean">  
	    <result property="agencyId" column="agencyId"/>  
	    <result property="serialNumber" column="serialNumber"/>  
	    <result property="agencyName" column="agencyName"/> 
	    <result property="onlyCode" column="onlyCode"/> 
	    <result property="dealTypeId" column="dealTypeId"/> 
	    <result property="dealTypeStr" column="dealTypeStr"/> 
	    <result property="dealData" column="dealData"/> 
	    <result property="transAcount" column="transAcount"/> 
	    <result property="feeAcount" column="feeAcount"/> 
		<result property="feeAmt" column="feeAmt"/> 
	    <result property="splitFeeAcount" column="splitFeeAcount"/> 
	</resultMap>    
	
	<resultMap id="getSplitFeeDealBean" class="SplitFeeDealBean">  
	    <result property="agencyId" column="agencyId"/>  
	    <result property="terminalCode" column="terminalCode"/>  
	    <result property="serialNumber" column="serialNumber"/>  
	    <result property="agencyName" column="agencyName"/> 
	    <result property="onlyCode" column="onlyCode"/> 
	    <result property="dealTypeId" column="dealTypeId"/> 
	    <result property="dealTypeStr" column="dealTypeStr"/> 
	    <result property="dealData" column="dealData"/> 
	    <result property="transAcount" column="transAcount"/> 
	    <result property="feeAcount" column="feeAcount"/> 
	     <result property="feeAmt" column="feeAmt"/> 
	     <result property="feeAmt" column="feeAmt"/> 
	     <result property="moneyLevel" column="moneyLevel"/> 
	     <result property="moneyLevelNext" column="moneyLevelNext"/><!-- 
	     <result property="oneSplitFeeAcount" column="oneSplitFeeAcount"/> 
	    <result property="twoSplitFeeAcount" column="twoSplitFeeAcount"/> 
	    <result property="threeSplitFeeAcount" column="threeSplitFeeAcount"/> 
	    <result property="fourSplitFeeAcount" column="fourSplitFeeAcount"/> 
	    <result property="fiveSplitFeeAcount" column="fiveSplitFeeAcount"/> 
	 --></resultMap> 
	
	
	 <resultMap id="getSplitFeeDealAllBean" class="SplitFeeDealBean">  
	    <result property="agencyId" column="agencyId"/>  
	    <result property="terminalCode" column="terminalCode"/>  
	    <result property="serialNumber" column="serialNumber"/>  
	    <result property="agencyName" column="agencyName"/> 
	    <result property="onlyCode" column="onlyCode"/> 
	    <result property="dealTypeId" column="dealTypeId"/> 
	    <result property="dealTypeStr" column="dealTypeStr"/> 
	    <result property="dealData" column="dealData"/> 
	    <result property="transAcount" column="transAcount"/> 
	    <result property="feeAcount" column="feeAcount"/> 
	     <result property="feeAmt" column="feeAmt"/> 
	     <result property="feeAmt" column="feeAmt"/><!-- 
	     <result property="moneyLevel" column="moneyLevel"/> 
	     <result property="moneyLevelNext" column="moneyLevelNext"/> 
	    --><result property="oneSplitFeeAcount" column="oneSplitFeeAcount"/> 
	    <result property="twoSplitFeeAcount" column="twoSplitFeeAcount"/> 
	    <result property="threeSplitFeeAcount" column="threeSplitFeeAcount"/> 
	    <result property="fourSplitFeeAcount" column="fourSplitFeeAcount"/> 
	    <result property="fiveSplitFeeAcount" column="fiveSplitFeeAcount"/> 
	 </resultMap>    
	    
	
	
	 <parameterMap id="paramMap" class="java.util.HashMap" >
	     <parameter property="reportData" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="agencyId" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="dealTypeId" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	</parameterMap> 
	
	<parameterMap id="paramMapDataCount" class="java.util.HashMap" >
	    <!-- <parameter property="yearmonth" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>-->
	     <parameter property="datestart" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="dateend" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="agencyId" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="agencyIdf" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="dealType" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
<!--   <parameter property="systemId" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/> -->
	     <parameter property="result" jdbcType="INTEGER" javaType="java.lang.Integer" mode="OUT" resultMap="beanMap" />   
	</parameterMap> 
	
	<parameterMap id="paramMapData" class="java.util.HashMap" >
	     <!-- <parameter property="yearmonth" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/> -->
	     <parameter property="datestart" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="dateend" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="agencyId" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="agencyIdf" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="dealType" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <!-- <parameter property="systemId" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/> -->
	     <parameter property="start" jdbcType="INTEGER" javaType="java.lang.Integer"  mode="IN"/>
	     <parameter property="end" jdbcType="INTEGER" javaType="java.lang.Integer" mode="IN"/>
	     <parameter property="result" jdbcType="ORACLECURSOR" javaType="java.sql.ResultSet" mode="OUT" resultMap="beanMap" />   
	</parameterMap> 
	
	<parameterMap id="splitFeeDealParamMap" class="java.util.HashMap" >
	     <parameter property="yearmonth" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="agencyId" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="dealTypeId" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	      <parameter property="start" jdbcType="INTEGER" javaType="java.lang.Integer" mode="IN"/>
	       <parameter property="end" jdbcType="INTEGER" javaType="java.lang.Integer" mode="IN"/>
	     <parameter property="result" jdbcType="ORACLECURSOR" javaType="java.sql.ResultSet" mode="OUT" resultMap="splitFeeDealBean" />   
	</parameterMap> 
	<parameterMap id="splitFeeDealParamMapCount" class="java.util.HashMap" >
	     <parameter property="yearmonth" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="agencyId" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="dealTypeId" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="result" jdbcType="INTEGER" javaType="java.lang.Integer" mode="OUT" resultMap="splitFeeDealBean" />   
	</parameterMap> 
	
	<parameterMap id="getSplitFeeDetailParamMap" class="java.util.HashMap" >
	       <parameter property="datestart" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	       <parameter property="dateend" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	      <parameter property="agencyId" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="dealTypeId" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="startValue" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		 <parameter property="endValue" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		 <parameter property="terminalId" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		 <parameter property="serialnumber" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		  <parameter property="levelCode" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		  <parameter property="flag" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		   <parameter property="start" jdbcType="INTEGER" javaType="java.lang.Integer" mode="IN"/>
		    <parameter property="end" jdbcType="INTEGER" javaType="java.lang.Integer" mode="IN"/>
		  <!-- 增加特别处理标志，如果设置本标志为YES，则只查询所选机构自身的交易-->
	     <parameter property="result" jdbcType="ORACLECURSOR" javaType="java.sql.ResultSet" mode="OUT" resultMap="getSplitFeeDealBean" />   
	</parameterMap> 
	
		<parameterMap id="getSplitFeeDetailAllParamMap" class="java.util.HashMap" >
	       <parameter property="datestart" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	       <parameter property="dateend" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	      <parameter property="agencyId" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="dealTypeId" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="startValue" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		 <parameter property="endValue" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		 <parameter property="terminalId" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		 <parameter property="serialnumber" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		  <parameter property="levelCode" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		  <parameter property="loginAgencyId" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		   <parameter property="start" jdbcType="INTEGER" javaType="java.lang.Integer" mode="IN"/>
		  <parameter property="end" jdbcType="INTEGER" javaType="java.lang.Integer" mode="IN"/>
	     <parameter property="result" jdbcType="ORACLECURSOR" javaType="java.sql.ResultSet" mode="OUT" resultMap="getSplitFeeDealAllBean" />   
	</parameterMap>
	
	<parameterMap id="getSplitFeeDetailParamMapCount" class="java.util.HashMap" >
	     <parameter property="datestart" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	      <parameter property="dateend" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="agencyId" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="dealTypeId" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="startValue" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		 <parameter property="endValue" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		 <parameter property="terminalId" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		 <parameter property="serialnumber" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		  <parameter property="levelCode" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		  <parameter property="flag" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="result" jdbcType="INTEGER" javaType="java.lang.Integer" mode="OUT" resultMap="getSplitFeeDealBean" />   
	</parameterMap>
	
	<parameterMap id="getSplitFeeDetailAllParamMapCount" class="java.util.HashMap" >
	     <parameter property="datestart" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	      <parameter property="dateend" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="agencyId" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="dealTypeId" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="startValue" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		 <parameter property="endValue" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		 <parameter property="terminalId" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		 <parameter property="serialnumber" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		  <parameter property="levelCode" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		  <parameter property="loginAgencyId" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
	     <parameter property="result" jdbcType="INTEGER" javaType="java.lang.Integer" mode="OUT" resultMap="getSplitFeeDealBean" />   
	</parameterMap>

	<!-- 获取分润计算的数据总个数 -->
	<select id="getSplitFeeCount" resultClass="java.lang.Integer" parameterClass="java.lang.String">
		 SELECT
			    count(1)
			FROM
			    LOG_PACKAGES
			WHERE
			    PROC_NAME = 'PROC_QT_ORG_PROFITS'
			    AND RETCODE=#agencyId#
			    AND STIME IN(
			        SELECT
			            MAX(STIME)
			        FROM
			            LOG_PACKAGES
			        WHERE
			            PROC_NAME = 'PROC_QT_ORG_PROFITS'
			    )
	</select>
	
	<!-- 获得分润计算执行日志 -->
	<select id="getSplitFeeLog" resultClass="SplitFeeBean" parameterClass="java.util.Map">
		SELECT
   			 *
		FROM
    	(
	        SELECT
	            d2. * ,
	            ROWNUM RN
	        FROM
	            (
	               SELECT
					    PROCESS_NO AS executeCode ,
					    PROCESS_REMARK AS executeDesc ,
					    STIME AS startTime ,
					    ETIME AS endTime ,
					    PROCESS_TIME AS executeTime ,
					    RUN_FLAG AS executeReult
					FROM
					    LOG_PACKAGES
					WHERE
					    PROC_NAME = 'PROC_QT_ORG_PROFITS'
					    AND RETCODE=#agencyId#
					    AND STIME IN(
					        SELECT
					            MAX(STIME)
					        FROM
					            LOG_PACKAGES
					        WHERE
					            PROC_NAME = 'PROC_QT_ORG_PROFITS'
					    )
	            ) d2
        WHERE
            ROWNUM <![CDATA[<=]]> #end#
   		 )
	WHERE
    	RN >= #start#
</select>
	
	<!-- 调用分润计算存储过程 -->
	<procedure id="splitFee" parameterMap="paramMap">
	
	  <![CDATA[
	    { call PROC_QT_ORG_PROFITS(?,?,?) }
	   ]]>
			
	</procedure>
	<select id="splitFeeByAgencyDealTypeCount" resultClass="java.lang.Integer" parameterClass="java.util.Map">
				SELECT  count(1)
			 FROM 
			(
				SELECT  T5.ONLINECHANNEL,
						T1.AGENCY_ID ,  
				        T1.DEAL_TYPE  ,   
				        T1.YEAR_MONTHS , 
				        NVL(T1.TRANSACOUNT,0) TRANSACOUNT , 
				        NVL(T1.count_id,0) count_id  ,   
				        NVL(T2.AMOUNT,0)  AMOUNT  ,     
				        NVL(T3.CALCULATION_TYPE,0) CALCULATION_TYPE, 
				        NVL(T4.PROFITS_TYPE,0) PROFITS_TYPE    
				 FROM(
				   SELECT #agencyId# AS AGENCY_ID,                              
				          T2.DT_ID  AS DEAL_TYPE,                        
				          TO_CHAR(T1.DEAL_DATA,'YYYYMM' ) YEAR_MONTHS,
				          SUM(T1.TRANSACOUNT)  TRANSACOUNT,             
				          COUNT(t1.ONLY_CODE) AS count_id      
				    FROM  QT1TBLDEAL       T1,                        
				          QT1TBLDEALTYPE   T2,                          
				          QT1TBLTERMINAL   T3,                      
				          (SELECT T.AGENCY_ID,
				                  T.ONLINECHANNEL
				             FROM rtb_qt1tblagency T
				             START WITH T.Agency_Id =#agencyId#
				             CONNECT BY PRIOR T.AGENCY_ID = T.ONLINECHANNEL
				          )T4
				   WHERE  T1.DEALREBACKCODE = '00'                       
				     AND  T1.DEALTYPE_ID = T2.DT_ID                    
				   <!--   AND  T1.TERMINAL_ONLYCODE = T3.ONLYCODE -->   
				     AND  T1.AGENCYID=T3.AGENCYID         
				     AND  T1.DEAL_STATUS = '0'                           
				     AND  T2.DT_STATUS   = '1'                           
				     AND  TO_CHAR(T1.DEAL_DATA,'YYYYMM' ) = #reportData#
				     AND  T3.AGENCYID = T4.AGENCY_ID
				     GROUP BY  T2.DT_ID ,TO_CHAR(T1.DEAL_DATA,'YYYYMM' )
				  ) T1
				LEFT JOIN(
				   SELECT T1.AGENCY_ID , 
				          T1.DEAL_TYPE , 
				          T1.AMOUNT 
				     FROM QT1TBLLDEAL_MONTHS T1
				    WHERE T1.YEAR_MONTHS =#reportData#
				      AND T1.AGENCY_ID =#agencyId#
				   )T2
				ON T1.AGENCY_ID = T2.AGENCY_ID
				AND T1.DEAL_TYPE = T2.DEAL_TYPE
				LEFT  JOIN (
				    SELECT T1.AGENCY_ID  , 
				           T1.DEAL_TYPE ,
				           T1.CALCULATION_TYPE 
				     FROM QT1TABLEORGcalculationTYPE T1
				    WHERE  T1.YEAR_MONTHS =#reportData#
				      AND  T1.AGENCY_ID =#agencyId#
				    )T3 
				ON T1.AGENCY_ID = T3.AGENCY_ID
				AND T1.DEAL_TYPE = T3.DEAL_TYPE
				LEFT JOIN (
				    SELECT T1.AGENCY_ID  , 
				           T1.DEAL_TYPE ,
				           T1.PROFITS_TYPE
				     FROM QT1TABLEORGPROFITSTYPE T1 
				   WHERE T1.YEAR_MONTHS =#reportData#
				     AND T1.AGENCY_ID =#agencyId#
				    )T4 
				ON T1.AGENCY_ID  = T4.AGENCY_ID
				AND T1.DEAL_TYPE = T4.DEAL_TYPE
				LEFT  JOIN 
		      (
		      SELECT T.ONLINECHANNEL FROM  rtb_qt1tblagency    T
		     	 WHERE T.AGENCY_ID =#agencyId#
			  )T5
				ON 1=1
				) T1
		LEFT JOIN 
		(
		    SELECT  DISTINCT T1.AGENCY_ID  , 
		           T1.DEAL_TYPE ,
		           T1.PROFITS_TYPE
		     FROM QT1TABLEORGPROFITSTYPE T1 
		   WHERE T1.YEAR_MONTHS =#reportData#
		)T2
		ON T1.ONLINECHANNEL = T2.AGENCY_ID
		AND T1.DEAL_TYPE = T2.DEAL_TYPE
		where T1.CALCULATION_TYPE!='1'
		  	 </select>
	
	<select id="splitFeeByAgencyDealType" resultClass="SplitFeeDealType" parameterClass="java.util.Map">
				SELECT  T1.ONLINECHANNEL AS   parentagencyId,
			        T1.AGENCY_ID AS agencyId,
			        GETUPPERAGENCYNAMEBYID(T1.AGENCY_ID ) AS agnecyName,
			        T1.DEAL_TYPE AS  dealtype,
			        GETDEALTYPENAMEBYID(T1.DEAL_TYPE) AS dealtypeStr,
			        T1.YEAR_MONTHS AS yearmonth,
			        T1.TRANSACOUNT AS  transCount,
			        T1.count_id  AS dealCount,
			        T1.AMOUNT AS  amount,
			        T1.CALCULATION_TYPE  AS  isAffirm,
			        CASE WHEN T1.CALCULATION_TYPE='1' then '已确认'  
					     ELSE '未确认'  END   AS isAffirmStr,
			        T1.PROFITS_TYPE AS isCalc,
			        CASE WHEN T1.PROFITS_TYPE='1' then '已计算'  
					     ELSE '未计算'  END   AS isCalcStr,
			        NVL(T2.PROFITS_TYPE,0) AS parentIsCalc
			 FROM 
			(
				SELECT  T5.ONLINECHANNEL,
						T1.AGENCY_ID ,  
				        T1.DEAL_TYPE  ,   
				        T1.YEAR_MONTHS , 
				        NVL(T1.TRANSACOUNT,0) TRANSACOUNT , 
				        NVL(T1.count_id,0) count_id  ,   
				        NVL(T2.AMOUNT,0)  AMOUNT  ,     
				        NVL(T3.CALCULATION_TYPE,0) CALCULATION_TYPE, 
				        NVL(T4.PROFITS_TYPE,0) PROFITS_TYPE    
				 FROM(
				   SELECT #agencyId# AS AGENCY_ID,                              
				          T2.DT_ID  AS DEAL_TYPE,                        
				          TO_CHAR(T1.DEAL_DATA,'YYYYMM' ) YEAR_MONTHS,
				          SUM(T1.TRANSACOUNT)  TRANSACOUNT,             
				          COUNT(t1.ONLY_CODE) AS count_id      
				    FROM  QT1TBLDEAL       T1,                        
				          QT1TBLDEALTYPE   T2,                          
				          QT1TBLTERMINAL   T3,                      
				          (SELECT T.AGENCY_ID,
				                  T.ONLINECHANNEL
				             FROM rtb_qt1tblagency T
				             START WITH T.Agency_Id =#agencyId#
				             CONNECT BY PRIOR T.AGENCY_ID = T.ONLINECHANNEL
				          )T4
				   WHERE  T1.DEALREBACKCODE = '00'                       
				     AND  T1.DEALTYPE_ID = T2.DT_ID                    
				   <!--   AND  T1.TERMINAL_ONLYCODE = T3.ONLYCODE  -->
				     AND  T1.AGENCYID = T3.AGENCYID           
				     AND  T1.DEAL_STATUS = '0'                           
				     AND  T2.DT_STATUS   = '1'                           
				     AND  TO_CHAR(T1.DEAL_DATA,'YYYYMM' ) = #reportData#
				     AND  T3.AGENCYID = T4.AGENCY_ID
				     GROUP BY  T2.DT_ID ,TO_CHAR(T1.DEAL_DATA,'YYYYMM' )
				  ) T1
				LEFT JOIN(
				   SELECT T1.AGENCY_ID , 
				          T1.DEAL_TYPE , 
				          T1.AMOUNT 
				     FROM QT1TBLLDEAL_MONTHS T1
				    WHERE T1.YEAR_MONTHS =#reportData#
				      AND T1.AGENCY_ID =#agencyId#
				   )T2
				ON T1.AGENCY_ID = T2.AGENCY_ID
				AND T1.DEAL_TYPE = T2.DEAL_TYPE
				LEFT  JOIN (
				    SELECT T1.AGENCY_ID  , 
				           T1.DEAL_TYPE ,
				           T1.CALCULATION_TYPE 
				     FROM QT1TABLEORGcalculationTYPE T1
				    WHERE  T1.YEAR_MONTHS =#reportData#
				      AND  T1.AGENCY_ID =#agencyId#
				    )T3 
				ON T1.AGENCY_ID = T3.AGENCY_ID
				AND T1.DEAL_TYPE = T3.DEAL_TYPE
				LEFT JOIN (
				    SELECT T1.AGENCY_ID  , 
				           T1.DEAL_TYPE ,
				           T1.PROFITS_TYPE
				     FROM QT1TABLEORGPROFITSTYPE T1 
				   WHERE T1.YEAR_MONTHS =#reportData#
				     AND T1.AGENCY_ID =#agencyId#
				    )T4 
				ON T1.AGENCY_ID  = T4.AGENCY_ID
				AND T1.DEAL_TYPE = T4.DEAL_TYPE
				LEFT  JOIN 
		      (
		      SELECT T.ONLINECHANNEL FROM  rtb_qt1tblagency    T
		     	 WHERE T.AGENCY_ID =#agencyId#
			  )T5
				ON 1=1
				) T1
		LEFT JOIN 
		(
		    SELECT  DISTINCT T1.AGENCY_ID  , 
		           T1.DEAL_TYPE ,
		           T1.PROFITS_TYPE
		     FROM QT1TABLEORGPROFITSTYPE T1 
		   WHERE T1.YEAR_MONTHS =#reportData#
		)T2
		ON T1.ONLINECHANNEL = T2.AGENCY_ID
		AND T1.DEAL_TYPE = T2.DEAL_TYPE
		  	 </select>
  	 
  	 <insert id="splitFeeAffirm" parameterClass="SplitFeeDealType">
				INSERT INTO QT1TABLEORGCALCULATIONTYPE
 				   ( 
 				    AGENCY_ID, 
 				    CALCULATION_TYPE, 
 				    YEAR_MONTHS, 
 				    DEAL_TYPE)
			 VALUES(
			 		#agencyId#,
			 		'1',
			 		#yearmonth#,
			 		#dealtype#
				)
  	 </insert>
  	 
  	 
  	<insert id="splitFeeCalc" parameterClass="SplitFeeDealType">
  	 	INSERT INTO QT1TABLEORGPROFITSTYPE
 				   (
 				    AGENCY_ID, 
 				    PROFITS_TYPE, 
 				    YEAR_MONTHS, 
 				    DEAL_TYPE)
			 VALUES(
			 		#agencyId#,
			 		'1',
			 		#yearmonth#,
			 		#dealtype#
				)
  	 </insert>
  	 
  	 <procedure id="getChildSplitFeeCount"  parameterMap="paramMapDataCount">
  	     <![CDATA[ call  proc_org_profits_detailed_co(?,?,?,?,?,?)]]>
	</procedure>
  	 
  	<procedure id="getChildSplitFee"  parameterMap="paramMapData">
        <![CDATA[ call  proc_org_profits_detailed(?,?,?,?,?,?,?,?)]]>
	</procedure>
     <procedure id="getChildHisSplitFeeCount"  parameterMap="paramMapDataCount">
  	     <![CDATA[ call  his_org_profits_detailed_co(?,?,?,?,?,?)]]>
	</procedure>
  	 
  	<procedure id="getChildHisSplitFee"  parameterMap="paramMapData">
        <![CDATA[ call  his_org_profits_detailed(?,?,?,?,?,?,?,?)]]>
	</procedure>
     
      <procedure id="splitFeeDetail"  parameterMap="splitFeeDealParamMap">
        <![CDATA[ call  proc_org_nos_profits_detailed(?,?,?,?,?,?)]]>
	</procedure>
	   <procedure id="splitFeeDetailCount"  parameterMap="splitFeeDealParamMapCount">
        <![CDATA[ call  PROC_PROFITS_DETAILED_COUNT(?,?,?,?)]]>
	</procedure>



	<procedure id="getSplitFeeDetailCount"  parameterMap="getSplitFeeDetailParamMapCount">
        <![CDATA[ call  proc_nos_detailed_count(?,?,?,?,?,?,?,?,?,?,?)]]>
	</procedure>
     <procedure id="getSplitFeeDetail"  parameterMap="getSplitFeeDetailParamMap" resultClass="SplitFeeDealBean">
        <![CDATA[ call  proc_nos_detailed(?,?,?,?,?,?,?,?,?,?,?,?,?)]]>
	</procedure>
	<procedure id="getHisSplitFeeDetailCount"  parameterMap="getSplitFeeDetailParamMapCount">
        <![CDATA[ call  his_nos_detailed_count(?,?,?,?,?,?,?,?,?,?,?)]]>
	</procedure>
     <procedure id="getHisSplitFeeDetail"  parameterMap="getSplitFeeDetailParamMap" resultClass="SplitFeeDealBean">
        <![CDATA[ call  his_nos_detailed(?,?,?,?,?,?,?,?,?,?,?,?,?)]]>
	</procedure>
	<procedure id="getSplitFeeDetailAllCount"  parameterMap="getSplitFeeDetailAllParamMapCount">
        <![CDATA[ call  proc_nos_detailedall_count(?,?,?,?,?,?,?,?,?,?,?)]]>
	</procedure>
	<procedure id="getSplitFeeDetailAll"  parameterMap="getSplitFeeDetailAllParamMap" resultClass="SplitFeeDealBean">
        <![CDATA[ call  proc_nos_detailedall(?,?,?,?,?,?,?,?,?,?,?,?,?)]]>
	</procedure>
	
	<insert id="addFlag" parameterClass="java.util.Map">
		insert into QTFLAG(agentId,typeId) values(#agencyId#,#typeId#)
	</insert>
	<select id="getFlag" resultClass="java.lang.Integer" parameterClass="java.lang.String">
		select count(1) 
		from QTFLAG 
		where agentId=#agencyId#
	</select>
	<delete id="delFlag" parameterClass="java.util.Map">
		DELETE FROM QTFLAG
		WHERE AGENTID=#agencyId# AND TYPEID=#typeId#
	</delete>  
	
	<insert id="splitFeeSum" parameterClass="java.util.Map">
				 INSERT INTO QT1TBLSPLIT_RESET
  				 (AGENCYID, STARTDATE, ENDDATE, STATUS, TIMESTAMP, PARENTAGENCYID， apply_agencyid,apply_date)
 					VALUES
  					 (
  					  #agencyId#,
  					  #datestart#,
  					  #dateend#,
  					  '0',
 					   #timestamp#,
   				       #parentAgencyId#,
					   #applyAgencyId#,
					   #applyDate#
   				      )
  	 </insert>
  	 
	
</sqlMap>