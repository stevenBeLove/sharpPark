<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="terminaldeal">
 

	<!-- 更新一个终端标记状态 -->
	<update id="updateFlagTerminal" parameterClass="TerminalDealBean">
		UPDATE TB_PAY_TERM_JNLS t
		SET FLAGSTATUS=#flagStatus#,
		    FLAGOPERTIME=#flagOperTime#,
			FLAGOPERATOR=#flagOperator#
		WHERE t.id in ($idStr$)
	</update>


	<!--获得终端交易列表 -->
	<select id="getViewTerminalDealCount" resultClass="java.lang.Integer" parameterClass="TerminalDealBean">
		SELECT count(1)
			 FROM (  SELECT 	 T.ID AS SERIALID
							FROM TB_PAY_TERM_JNLS T
							INNER JOIN  rtb_qt1tblagency B
							  ON T.AGENCYID = B.AGENCY_ID
							  AND B.ONLINECHANNEL = #curAgencyId# 
		 				WHERE 1=1
						 
							<isNotEmpty property="activateStandard">
					            <![CDATA[ AND t.standardamount >=#activateStandard# ]]>
							</isNotEmpty>
							<isNotEmpty property="startCode">
								   <![CDATA[AND t.terminalcode>=#startCode#]]>
							</isNotEmpty>
							<isNotEmpty property="endCode">
			                        <![CDATA[ AND t.terminalcode<=#endCode# ]]>
							</isNotEmpty>
							<isNotEmpty property="agencyName">
								AND B.COMPANYNAME LIKE '%$agencyName$%'
							</isNotEmpty>
							<isNotEmpty property="agencyId">
									AND t.agencyid=#agencyId#
							</isNotEmpty>
							<isNotEmpty property="flagStatus">
									AND t.flagstatus in ($flagStatus$)
							</isNotEmpty>
							<isNotEmpty property="activeDateStart">
								AND t.standarddate>=#activeDateStart#
							</isNotEmpty>
							<isNotEmpty property="activeDateEnd">
			                    <![CDATA[ AND t.standarddate<=#activeDateEnd# ]]>
							</isNotEmpty>
							<isNotEmpty property="customerId">
			                            AND t.customerId=#customerId#
							</isNotEmpty>
			 							 ) d2
	</select>


	<!--获得终端交易列表 -->
	<select id="getViewTermnalDealList" resultClass="TerminalDealBean"
		parameterClass="TerminalDealBean">
		SELECT *
			FROM (SELECT D2. *, ROWNUM RN
				FROM ( SELECT  T.ID AS SERIALID,
						       T.STARTDATE,
						       T.ENDDATE,
						       T.AGENCYID,
						       T.TERMINALCODE,
						       T.STANDARDDATE,
						       T.STANDARDAMOUNT,
						       T.FLAGSTATUS,
						       T.CREATEDT,
						       T.FLAGOPERATOR,
						       T.FLAGOPERTIME,
						       B.COMPANYNAME AS AGENCYNAME,
						       T.CUSTOMERID 
							FROM TB_PAY_TERM_JNLS T
							INNER JOIN  rtb_qt1tblagency   B				
							  ON T.AGENCYID = B.AGENCY_ID
							  AND B.ONLINECHANNEL =#curAgencyId# 
		 				WHERE 1=1
						 
							<isNotEmpty property="activateStandard">
					            <![CDATA[ AND t.standardamount >=#activateStandard# ]]>
							</isNotEmpty>
							<isNotEmpty property="startCode">
								   <![CDATA[AND t.terminalcode>=#startCode#]]>
							</isNotEmpty>
							<isNotEmpty property="endCode">
			                        <![CDATA[ AND t.terminalcode<=#endCode# ]]>
							</isNotEmpty>
							<isNotEmpty property="agencyId">
									AND t.agencyid=#agencyId#
							</isNotEmpty>
							<isNotEmpty property="agencyName">
							AND B.COMPANYNAME LIKE '%$agencyName$%'
							</isNotEmpty>
							<isNotEmpty property="flagStatus">
									AND t.flagstatus  in ($flagStatus$)
							</isNotEmpty>
						    <isNotEmpty property="activeDateStart">
								AND t.standarddate>=#activeDateStart#
							</isNotEmpty>
							<isNotEmpty property="activeDateEnd">
			                    <![CDATA[ AND t.standarddate<=#activeDateEnd# ]]>
							</isNotEmpty>
							<isNotEmpty property="customerId">
			                            AND t.customerId=#customerId#
							</isNotEmpty>
			 							 ) d2
					WHERE ROWNUM <![CDATA[<=]]>
		    	#end#
			)
		WHERE RN > #start#
	</select>
	
	
	<select id="getTerDealCount" resultClass="java.lang.Integer" parameterClass="TerminalDealBean">
		 select count(1)
			  from (select tt1.*
			          from (select MAT.PARENTAGENCYiD,
			                       MAT.PARENTCOMPANYNAME,
			                       D.TERMINAL_ONLYCODE,
			                       D.CUSTOMERID,
								   sum(d.transacount) as sumAmt
			                  from qt1tbldeal d
			                 inner join TABLE(QUERY_AGENCY.PRODFUNC(#curAgencyId#)) MAT
			                    ON MAT.AGENCY_ID = d.AGENCYID
			                 inner JOIN QT1TBLTERMINAL T2
			                    ON d.TERMINAL_ONLYCODE = t2.terminalcode
			                   and t2.agencyid = mat.AGENCY_ID
			                 where   d.customerid is not null
					<isNotEmpty property="startDate">
						<![CDATA[ AND D.DEAL_DATA>= TO_DATE(#startDate#, 'YYYYMMDD') ]]>
					 </isNotEmpty>
					 <isNotEmpty property="endDate">
						<![CDATA[ AND D.DEAL_DATA<=TO_DATE(#endDate#, 'YYYYMMDD') ]]>
					 </isNotEmpty>
					 <isNotEmpty property="agencyId">
						  AND MAT.PARENTAGENCYID = #agencyId#
					 </isNotEmpty>
					 <isNotEmpty property="startCode">
						<![CDATA[ AND   D.TERMINAL_ONLYCODE >= #startCode#]]>
					 </isNotEmpty>
					 <isNotEmpty property="endCode">
						<![CDATA[ AND  D.TERMINAL_ONLYCODE <= #endCode# ]]>
					 </isNotEmpty>
					 <isNotEmpty property="agencyName">
							      AND MAT.PARENTCOMPANYNAME LIKE '%$agencyName$%'
				     </isNotEmpty>
				     <isNotEmpty property="customerId">
							      AND D.CUSTOMERID  = #customerId#
				     </isNotEmpty>
			                   and not exists
			                 (select 1
			                          from qt1tbldeal qd
			                         where d.customerid = qd.customerid  
			                      <![CDATA[  and qd.deal_data < to_date(#startDate#, 'yyyymmdd')) ]]>
			                          and not exists
			                 (select 1
			                          from qt1tbldeal qd
			                         where d.terminal_onlycode = qd.terminal_onlycode
			                      <![CDATA[  and qd.deal_data < to_date(#startDate#, 'yyyymmdd')) ]]>
			                   and not exists
			                 (select 1
			                          from tb_his_qt1tbldeal hd
			                         where d.customerid = hd.customerid 
			                       <![CDATA[  and hd.deal_data < to_date(#startDate#, 'yyyymmdd')) ]]>
			                        and not exists
			                 (select 1
			                          from tb_his_qt1tbldeal hd
			                         where 
			                               d.terminal_onlycode = hd.terminal_onlycode
			                       <![CDATA[  and hd.deal_data < to_date(#startDate#, 'yyyymmdd')) ]]>
			                   and D.DEALTYPE_ID IN ($dealTypeId$)
			                   and NOT EXISTS
			                 (SELECT 1
			                          FROM TB_PAY_TERM_JNLS TJ
			                         WHERE  TJ.TERMINALCODE = d.TERMINAL_ONLYCODE  
			                               
			                           and TJ.AGENCYID = MAT.parentagencyid
			                          <![CDATA[  and TJ.AGENCYID <> #curAgencyId# ]]>)
			                       and NOT EXISTS
			                 (SELECT 1
			                          FROM TB_PAY_TERM_JNLS TJ
			                         WHERE  
			                               tj.customerid = d.customerid
			                           and TJ.AGENCYID = MAT.parentagencyid
			                          <![CDATA[  and TJ.AGENCYID <> #curAgencyId# ]]>)
					    <isNotEmpty property="startDate">
							   <![CDATA[ AND   T2.OPENDATE >=#startDate#]]>
						 </isNotEmpty>
						 <isNotEmpty property="endDate">
			                   <![CDATA[ AND  T2.OPENDATE <=#endDate# ]]>
						 </isNotEmpty>
			                 GROUP BY d.agencyid,
			                          D.TERMINAL_ONLYCODE,
			                          D.CUSTOMERID,
			                          MAT.PARENTAGENCYiD,
			                          MAT.PARENTCOMPANYNAME) tt1
			         inner join (select tt.terminal_onlycode, tt.customerid, min(rn) rn
			                      from (select d.terminal_onlycode,
			                                   d.customerid,
			                                   row_number() over(partition by d.customerid order by d.deal_data, d.deal_time) rn
			                              from qt1tbldeal d
			                             inner join TABLE(QUERY_AGENCY.PRODFUNC(#curAgencyId#)) MAT
			                                ON MAT.AGENCY_ID = d.AGENCYID
			                             where  d.customerid is not null
							    <isNotEmpty property="startDate">
										   AND D.DEAL_DATA>= TO_DATE(#startDate#, 'YYYYMMDD')
							 </isNotEmpty>
							 <isNotEmpty property="endDate">
								 <![CDATA[ AND D.DEAL_DATA<=TO_DATE(#endDate#, 'YYYYMMDD') ]]>
							 </isNotEmpty>
							 <isNotEmpty property="agencyId">
								           AND MAT.PARENTAGENCYID = #agencyId#
							 </isNotEmpty>
							 <isNotEmpty property="agencyName">
							               AND MAT.PARENTCOMPANYNAME LIKE '%$agencyName$%'
				             </isNotEmpty>
				             <isNotEmpty property="customerId">
							             AND D.CUSTOMERID  = #customerId#
				             </isNotEmpty>
				             <isNotEmpty property="startCode">
								<![CDATA[ AND   D.TERMINAL_ONLYCODE >= #startCode#]]>
							 </isNotEmpty>
							 <isNotEmpty property="endCode">
								<![CDATA[ AND  D.TERMINAL_ONLYCODE <= #endCode# ]]>
							 </isNotEmpty>
			                               and not exists
			                             (select 1
			                                      from qt1tbldeal qd
			                                     where d.customerid = qd.customerid 
			                                     <![CDATA[   and qd.deal_data <   to_date(#startDate#, 'yyyymmdd') ]]>)
			                                        and not exists
			                             (select 1
			                                      from qt1tbldeal qd
			                                     where 
			                                           d.terminal_onlycode = qd.terminal_onlycode
			                                     <![CDATA[   and qd.deal_data <   to_date(#startDate#, 'yyyymmdd') ]]>)
			                               and not exists
			                             (select 1
			                                      from tb_his_qt1tbldeal hd
			                                     where d.customerid = hd.customerid 
			                                          
			                                    <![CDATA[  and hd.deal_data <  to_date(#startDate#, 'yyyymmdd') ]]>)
			                                and not exists
			                             (select 1
			                                      from tb_his_qt1tbldeal hd
			                                     where 
			                                           d.terminal_onlycode =  hd.terminal_onlycode
			                                    <![CDATA[  and hd.deal_data <  to_date(#startDate#, 'yyyymmdd') ]]>)
			                               and NOT EXISTS
			                             (SELECT 1
			                                      FROM TB_PAY_TERM_JNLS TJ
			                                     WHERE (TJ.TERMINALCODE =
			                                           d.TERMINAL_ONLYCODE and
			                                           tj.customerid = d.customerid)
			                                       and TJ.AGENCYID = MAT.parentagencyid
			                             <![CDATA[ and TJ.AGENCYID <> #curAgencyId# ]]>)
			                               and D.DEALTYPE_ID IN ($dealTypeId$)) tt
			                     group by tt.terminal_onlycode, tt.customerid) tt2
			            on tt1.TERMINAL_ONLYCODE = tt2.terminal_onlycode
						WHERE  1=1
			 			 <isNotEmpty property="activateStandard">
					       <![CDATA[ AND  tt1.sumAmt >=#activateStandard# ]]>
					    </isNotEmpty>)
	</select>
 
	<select id="getTerDealList" resultClass="TerminalDealBean" parameterClass="TerminalDealBean">
		 SELECT B.*
			  FROM (SELECT #startDate# AS STARTDATE,
						   #endDate# AS ENDDATE,
			               A.PARENTAGENCYID AS AGENCYID,
			               A.PARENTCOMPANYNAME  AS AGENCYNAME,
			               A.TERMINAL_ONLYCODE AS TERMINALCODE,
			               A.CUSTOMERID,
			               A.FLAG,
			               A.sumAmt  AS TRANSAMOUNT,
			               ROWNUM RN
			          FROM (SELECT TT1.*,
			                       TT2.RN,
			                       CASE
			                         WHEN TT2.RN = 1 THEN
			                          '1'
			                         ELSE
			                          '0'
			                       END FLAG
			                  FROM (SELECT MAT.PARENTAGENCYID,
			                               MAT.PARENTCOMPANYNAME,
			                               
			                               D.TERMINAL_ONLYCODE,
			                               D.CUSTOMERID,
			                               SUM(D.TRANSACOUNT) AS   sumAmt
			                          FROM QT1TBLDEAL D
			                         INNER JOIN TABLE(QUERY_AGENCY.PRODFUNC(#curAgencyId#)) MAT
			                            ON MAT.AGENCY_ID = D.AGENCYID
			                         INNER JOIN QT1TBLTERMINAL T2
			                            ON D.TERMINAL_ONLYCODE = T2.TERMINALCODE
			                           AND T2.AGENCYID = MAT.AGENCY_ID
			                         WHERE  D.CUSTOMERID IS NOT NULL
							<isNotEmpty property="startDate">
										AND D.DEAL_DATA>= TO_DATE(#startDate#, 'YYYYMMDD')
							 </isNotEmpty>
							 <isNotEmpty property="endDate">
								<![CDATA[ AND D.DEAL_DATA<=TO_DATE(#endDate#, 'YYYYMMDD') ]]>
							 </isNotEmpty>
							 <isNotEmpty property="agencyId">
								  AND MAT.PARENTAGENCYID = #agencyId#
							 </isNotEmpty>
							 <isNotEmpty property="startCode">
								<![CDATA[ AND   D.TERMINAL_ONLYCODE >= #startCode#]]>
							 </isNotEmpty>
							 <isNotEmpty property="endCode">
								<![CDATA[ AND  D.TERMINAL_ONLYCODE <= #endCode# ]]>
							 </isNotEmpty>
							 <isNotEmpty property="agencyName">
										  AND MAT.PARENTCOMPANYNAME LIKE '%$agencyName$%'
							 </isNotEmpty>
							 <isNotEmpty property="customerId">
							              AND D.CUSTOMERID  = #customerId#
				             </isNotEmpty>
			                           AND NOT EXISTS
			                         (SELECT 1
			                                  FROM QT1TBLDEAL QD
			                                 WHERE D.CUSTOMERID = QD.CUSTOMERID 
			                                <![CDATA[     AND QD.DEAL_DATA < TO_DATE(#startDate#, 'YYYYMMDD') ]]>)
			                              AND NOT EXISTS
			                         (SELECT 1
			                                  FROM QT1TBLDEAL QD
			                                 WHERE
			                                       D.TERMINAL_ONLYCODE = QD.TERMINAL_ONLYCODE
			                                <![CDATA[     AND QD.DEAL_DATA < TO_DATE(#startDate#, 'YYYYMMDD') ]]>)
			                           AND NOT EXISTS
			                         (SELECT 1
			                                  FROM TB_HIS_QT1TBLDEAL HD
			                                 WHERE D.CUSTOMERID = HD.CUSTOMERID  
			                                  <![CDATA[   AND HD.DEAL_DATA <  TO_DATE( #startDate# , 'YYYYMMDD') ]]> )
			                                    AND NOT EXISTS
			                         (SELECT 1
			                                  FROM TB_HIS_QT1TBLDEAL HD
			                                 WHERE 
			                                       D.TERMINAL_ONLYCODE = HD.TERMINAL_ONLYCODE
			                                  <![CDATA[   AND HD.DEAL_DATA <  TO_DATE( #startDate# , 'YYYYMMDD') ]]> )
			                           AND D.DEALTYPE_ID IN ($dealTypeId$)
			                           AND NOT EXISTS
			                         (SELECT 1
			                                  FROM TB_PAY_TERM_JNLS TJ
			                                 WHERE  TJ.TERMINALCODE = D.TERMINAL_ONLYCODE 
			                                   AND TJ.AGENCYID = MAT.PARENTAGENCYID
			                                 <![CDATA[    AND TJ.AGENCYID <> #curAgencyId# ]]>)
			                              AND NOT EXISTS
			                         (SELECT 1
			                                  FROM TB_PAY_TERM_JNLS TJ
			                                 WHERE  
			                                       TJ.CUSTOMERID = D.CUSTOMERID 
			                                   AND TJ.AGENCYID = MAT.PARENTAGENCYID
			                                 <![CDATA[    AND TJ.AGENCYID <> #curAgencyId# ]]>)
						 <isNotEmpty property="startDate">
							   <![CDATA[ AND   T2.OPENDATE >=#startDate#]]>
						 </isNotEmpty>
						 <isNotEmpty property="endDate">
			                   <![CDATA[ AND  T2.OPENDATE <=#endDate# ]]>
						 </isNotEmpty>
			                         GROUP BY D.AGENCYID,
			                                  D.TERMINAL_ONLYCODE,
			                                  D.CUSTOMERID,
			                                  MAT.PARENTAGENCYID,
			                                  MAT.PARENTCOMPANYNAME) TT1
			                 INNER JOIN (SELECT TT.TERMINAL_ONLYCODE,
			                                   TT.CUSTOMERID,
			                                   MIN(RN) RN
			                              FROM (SELECT D.TERMINAL_ONLYCODE,
			                                           D.CUSTOMERID,
			                                           ROW_NUMBER() OVER(PARTITION BY D.CUSTOMERID ORDER BY D.DEAL_DATA, D.DEAL_TIME) RN
			                                      FROM QT1TBLDEAL D
			                                     INNER JOIN TABLE(QUERY_AGENCY.PRODFUNC(#curAgencyId#)) MAT
			                                        ON MAT.AGENCY_ID = D.AGENCYID
			                                     WHERE   D.CUSTOMERID IS NOT NULL
									  <isNotEmpty property="startDate">
												   AND D.DEAL_DATA>= TO_DATE(#startDate#, 'YYYYMMDD')
									 </isNotEmpty>
									 <isNotEmpty property="endDate">
										 <![CDATA[ AND D.DEAL_DATA<=TO_DATE(#endDate#, 'YYYYMMDD') ]]>
									 </isNotEmpty>
									 <isNotEmpty property="agencyId">
												   AND MAT.PARENTAGENCYID = #agencyId#
									 </isNotEmpty>
									 <isNotEmpty property="agencyName">
										  AND MAT.PARENTCOMPANYNAME LIKE '%$agencyName$%'
									 </isNotEmpty>
									  <isNotEmpty property="customerId">
									              AND D.CUSTOMERID  = #customerId#
						             </isNotEmpty>
						             <isNotEmpty property="startCode">
										<![CDATA[ AND   D.TERMINAL_ONLYCODE >= #startCode#]]>
									 </isNotEmpty>
									 <isNotEmpty property="endCode">
										<![CDATA[ AND  D.TERMINAL_ONLYCODE <= #endCode# ]]>
									 </isNotEmpty>
			                                       AND NOT EXISTS (SELECT 1
			                                              FROM QT1TBLDEAL QD
			                                             WHERE D.CUSTOMERID = QD.CUSTOMERID 
			                                                   
			                                       <![CDATA[   AND QD.DEAL_DATA < TO_DATE(#startDate#, 'YYYYMMDD') ]]>)
			                                        AND NOT EXISTS (SELECT 1
			                                              FROM QT1TBLDEAL QD
			                                             WHERE  D.TERMINAL_ONLYCODE = QD.TERMINAL_ONLYCODE
			                                       <![CDATA[   AND QD.DEAL_DATA < TO_DATE(#startDate#, 'YYYYMMDD') ]]>)
			                                       AND NOT EXISTS (SELECT 1
			                                              FROM TB_HIS_QT1TBLDEAL HD
			                                             WHERE D.CUSTOMERID = HD.CUSTOMERID 
															   
			                                        <![CDATA[  AND HD.DEAL_DATA < TO_DATE(#startDate#, 'YYYYMMDD') ]]>)
			                                         AND NOT EXISTS (SELECT 1
			                                              FROM TB_HIS_QT1TBLDEAL HD
			                                             WHERE    D.TERMINAL_ONLYCODE = HD.TERMINAL_ONLYCODE
			                                        <![CDATA[  AND HD.DEAL_DATA < TO_DATE(#startDate#, 'YYYYMMDD') ]]>)
			                                       AND NOT EXISTS
			                                     (SELECT 1
			                                              FROM TB_PAY_TERM_JNLS TJ
			                                             WHERE TJ.TERMINALCODE = D.TERMINAL_ONLYCODE  
			                                               AND TJ.AGENCYID =  MAT.PARENTAGENCYID
			                                         <![CDATA[ AND TJ.AGENCYID <> #curAgencyId# ]]>)
			                                          AND NOT EXISTS
			                                     (SELECT 1
			                                              FROM TB_PAY_TERM_JNLS TJ
			                                             WHERE   TJ.CUSTOMERID = D.CUSTOMERID
			                                               AND TJ.AGENCYID =  MAT.PARENTAGENCYID
			                                         <![CDATA[ AND TJ.AGENCYID <> #curAgencyId# ]]>)
			                                       AND D.DEALTYPE_ID IN ($dealTypeId$)) TT
			                             GROUP BY TT.TERMINAL_ONLYCODE, TT.CUSTOMERID) TT2
			                    ON TT1.TERMINAL_ONLYCODE = TT2.TERMINAL_ONLYCODE
							 WHERE   1=1
			 			 <isNotEmpty property="activateStandard">
					       <![CDATA[ AND  tt1.sumAmt >=#activateStandard# ]]>
					    </isNotEmpty>
			                 GROUP BY TT1.PARENTAGENCYID,
			                          TT1.PARENTCOMPANYNAME,
			                          TT1.CUSTOMERID,
			                          TT1.TERMINAL_ONLYCODE,
			                          TT1.sumAmt,
			                          TT2.RN
			                 ORDER BY TT1.PARENTAGENCYID,
			                          TT1.CUSTOMERID,
			                          TT1.TERMINAL_ONLYCODE) A) B
			 WHERE RN >  #start#
			   AND RN  <![CDATA[<=]]> #end#
	</select>
	
	
    <insert id="insertTermDeal"  parameterClass="TerminalDealBean" >
	     INSERT INTO TB_PAY_TERM_JNLS
				(ID,
				 STARTDATE,
				 ENDDATE,
				 AGENCYID,
				 TERMINALCODE,
				 FLAGSTATUS,
			 	 FLAGOPERTIME,
			 	 FLAGOPERATOR,
			 	 STANDARDDATE,
			     STANDARDAMOUNT,
			     CUSTOMERID)
			SELECT SEQ_TERM_JNLS.NEXTVAL, B.*
				FROM (  
						SELECT #startDate# AS STARTDATE,
						       #endDate# AS ENDDATE,
						       AGENCY_ID,
						       TERMINAL_ID,
						       '1',
						       TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') AS TIME,
						       #flagOperator#,
						       to_char(minDate,'yyyymmdd'),
						       #activateStandard#,
						       CUSTOMERID
						  FROM (SELECT DD.AGENCY_ID,DD.CUSTOMERID, DD.TERMINAL_ID, MIN(DD.DEAL_DATA) as minDate
						          FROM (SELECT MAT.PARENTAGENCYID AS AGENCY_ID,
						          			   D.CUSTOMERID,
						                       D.TERMINAL_ONLYCODE AS TERMINAL_ID,
						                       D.DEAL_DATA,
						                       SUM(D.TRANSACOUNT) OVER(ORDER BY D.DEAL_DATA, D.DEAL_TIME ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS SUMM
						                  FROM TABLE(QUERY_AGENCY.PRODFUNC(#curAgencyId#)) MAT
						                 INNER JOIN QT1TBLDEAL D
						                    ON MAT.AGENCY_ID = D.AGENCYID
						                 WHERE 	D.CUSTOMERID IS NOT NULL
						                 	 AND NOT EXISTS
									                   ( SELECT 1
							                            FROM TB_PAY_TERM_JNLS TJ
							                            INNER JOIN (SELECT TA.AGENCY_ID
									                                 FROM rtb_qt1tblagency TA
									                                WHERE TA.ONLINECHANNEL = #curAgencyId# 
									                             ) TT
									                       ON TJ.AGENCYID = TT.AGENCY_ID
							                           WHERE TJ.TERMINALCODE =  D.TERMINAL_ONLYCODE  )
						                        <isNotEmpty property="agencyId">
									                AND MAT.PARENTAGENCYID = #agencyId#
									             </isNotEmpty>
									         	 <isNotEmpty property="dealTypeId">
													AND D.DEALTYPE_ID IN ($dealTypeId$)
											     </isNotEmpty>
									             <isNotEmpty property="startDate">
													AND D.DEAL_DATA>= TO_DATE(#startDate#, 'YYYYMMDD')
												 </isNotEmpty>
												 <isNotEmpty property="endDate">
								                    <![CDATA[ AND D.DEAL_DATA<=TO_DATE(#endDate#, 'YYYYMMDD') ]]>
												 </isNotEmpty>
								                 <![CDATA[    AND  D.TERMINAL_ONLYCODE IN  ($terminalCodeStr$) ]]>
								                  <isNotEmpty property="customerId">
														       AND D.CUSTOMERID  = #customerId#
											       </isNotEmpty>
								                 ) DD
						         WHERE SUMM > #activateStandard# 
						         GROUP BY DD.AGENCY_ID, DD.CUSTOMERID,DD.TERMINAL_ID)
						) B
    </insert>
    
    <delete id="delTermDeal"  parameterClass="TerminalDealBean" >
           DELETE FROM  TB_PAY_TERM_JNLS J
           WHERE J.TERMINALCODE IN  ($terminalCodeStr$)
    </delete>

	<select id="getOldTerDealCount" resultClass="java.lang.Integer" parameterClass="TerminalDealBean">
		 select count(1)
			  from (select tt1.*
			          from (select MAT.PARENTAGENCYiD,
			                       MAT.PARENTCOMPANYNAME,
			                       D.TERMINAL_ONLYCODE,
			                       D.CUSTOMERID,
								   sum(d.transacount) as sumAmt
			                  from tb_his_qt1tbldeal d
			                 inner join TABLE(QUERY_AGENCY.PRODFUNC(#curAgencyId#)) MAT
			                    ON MAT.AGENCY_ID = d.AGENCYID
			                 inner JOIN QT1TBLTERMINAL T2
			                    ON d.TERMINAL_ONLYCODE = t2.terminalcode
			                   and t2.agencyid = mat.AGENCY_ID
			                 where   d.customerid is not null
					<isNotEmpty property="startDate">
						<![CDATA[ AND D.DEAL_DATA>= TO_DATE(#startDate#, 'YYYYMMDD') ]]>
					 </isNotEmpty>
					 <isNotEmpty property="endDate">
						<![CDATA[ AND D.DEAL_DATA<=TO_DATE(#endDate#, 'YYYYMMDD') ]]>
					 </isNotEmpty>
					 <isNotEmpty property="agencyId">
						  AND MAT.PARENTAGENCYID = #agencyId#
					 </isNotEmpty>
					 <isNotEmpty property="startCode">
						<![CDATA[ AND   D.TERMINAL_ONLYCODE >= #startCode#]]>
					 </isNotEmpty>
					 <isNotEmpty property="endCode">
						<![CDATA[ AND  D.TERMINAL_ONLYCODE <= #endCode# ]]>
					 </isNotEmpty>
					 <isNotEmpty property="agencyName">
							      AND MAT.PARENTCOMPANYNAME LIKE '%$agencyName$%'
				     </isNotEmpty>
				     <isNotEmpty property="customerId">
							      AND D.CUSTOMERID  = #customerId#
				     </isNotEmpty>
			            
			                   and not exists
			                 (select 1
			                          from tb_his_qt1tbldeal hd
			                         where d.customerid = hd.customerid
			                       <![CDATA[  and hd.deal_data < to_date(#startDate#, 'yyyymmdd')) ]]>
			                   and not exists
			                 (select 1
			                          from tb_his_qt1tbldeal hd
			                         where 
			                               d.terminal_onlycode = hd.terminal_onlycode
			                       <![CDATA[  and hd.deal_data < to_date(#startDate#, 'yyyymmdd')) ]]>
			                   and D.DEALTYPE_ID IN ($dealTypeId$)
			                   and NOT EXISTS
			                 (SELECT 1
			                          FROM TB_PAY_TERM_JNLS TJ
			                         WHERE (TJ.TERMINALCODE = d.TERMINAL_ONLYCODE and
			                               tj.customerid = d.customerid)
			                           and TJ.AGENCYID = MAT.parentagencyid
			                          <![CDATA[  and TJ.AGENCYID <> #curAgencyId# ]]>)
					    <isNotEmpty property="startDate">
							   <![CDATA[ AND   T2.OPENDATE >=#startDate#]]>
						 </isNotEmpty>
						 <isNotEmpty property="endDate">
			                   <![CDATA[ AND  T2.OPENDATE <=#endDate# ]]>
						 </isNotEmpty>
			                 GROUP BY d.agencyid,
			                          D.TERMINAL_ONLYCODE,
			                          D.CUSTOMERID,
			                          MAT.PARENTAGENCYiD,
			                          MAT.PARENTCOMPANYNAME) tt1
			         inner join (select tt.terminal_onlycode, tt.customerid, min(rn) rn
			                      from (select d.terminal_onlycode,
			                                   d.customerid,
			                                   row_number() over(partition by d.customerid order by d.deal_data, d.deal_time) rn
			                              from tb_his_qt1tbldeal d
			                             inner join TABLE(QUERY_AGENCY.PRODFUNC(#curAgencyId#)) MAT
			                                ON MAT.AGENCY_ID = d.AGENCYID
			                             where  d.customerid is not null
							    <isNotEmpty property="startDate">
										   AND D.DEAL_DATA>= TO_DATE(#startDate#, 'YYYYMMDD')
							 </isNotEmpty>
							 <isNotEmpty property="endDate">
								 <![CDATA[ AND D.DEAL_DATA<=TO_DATE(#endDate#, 'YYYYMMDD') ]]>
							 </isNotEmpty>
							 <isNotEmpty property="agencyId">
								           AND MAT.PARENTAGENCYID = #agencyId#
							 </isNotEmpty>
							 <isNotEmpty property="agencyName">
							               AND MAT.PARENTCOMPANYNAME LIKE '%$agencyName$%'
				             </isNotEmpty>
				             <isNotEmpty property="customerId">
							             AND D.CUSTOMERID  = #customerId#
				             </isNotEmpty>
				             <isNotEmpty property="startCode">
								<![CDATA[ AND   D.TERMINAL_ONLYCODE >= #startCode#]]>
							 </isNotEmpty>
							 <isNotEmpty property="endCode">
								<![CDATA[ AND  D.TERMINAL_ONLYCODE <= #endCode# ]]>
							 </isNotEmpty>
			                             
			                               and not exists
			                             (select 1
			                                      from tb_his_qt1tbldeal hd
			                                     where  d.customerid = hd.customerid  
			                                    <![CDATA[  and hd.deal_data <  to_date(#startDate#, 'yyyymmdd') ]]>)
			                                    and not exists
			                             (select 1
			                                      from tb_his_qt1tbldeal hd
			                                     where  
			                                           d.terminal_onlycode =  hd.terminal_onlycode 
			                                    <![CDATA[  and hd.deal_data <  to_date(#startDate#, 'yyyymmdd') ]]>)
			                               and NOT EXISTS
			                             (SELECT 1
			                                      FROM TB_PAY_TERM_JNLS TJ
			                                     WHERE (TJ.TERMINALCODE =
			                                           d.TERMINAL_ONLYCODE and
			                                           tj.customerid = d.customerid)
			                                       and TJ.AGENCYID = MAT.parentagencyid
			                             <![CDATA[ and TJ.AGENCYID <> #curAgencyId# ]]>)
			                               and D.DEALTYPE_ID IN ($dealTypeId$)) tt
			                     group by tt.terminal_onlycode, tt.customerid) tt2
			            on tt1.TERMINAL_ONLYCODE = tt2.terminal_onlycode
						WHERE  1=1
			 			 <isNotEmpty property="activateStandard">
					       <![CDATA[ AND  tt1.sumAmt >=#activateStandard# ]]>
					    </isNotEmpty>)
	</select>
 
	<select id="getOldTerDealList" resultClass="TerminalDealBean" parameterClass="TerminalDealBean">
		 SELECT B.*
			  FROM (SELECT #startDate# AS STARTDATE,
						   #endDate# AS ENDDATE,
			               A.PARENTAGENCYID AS AGENCYID,
			               A.PARENTCOMPANYNAME  AS AGENCYNAME,
			               A.TERMINAL_ONLYCODE AS TERMINALCODE,
			               A.CUSTOMERID,
			               A.FLAG,
			               A.sumAmt  AS TRANSAMOUNT,
			               ROWNUM RN
			          FROM (SELECT TT1.*,
			                       TT2.RN,
			                       CASE
			                         WHEN TT2.RN = 1 THEN
			                          '1'
			                         ELSE
			                          '0'
			                       END FLAG
			                  FROM (SELECT MAT.PARENTAGENCYID,
			                               MAT.PARENTCOMPANYNAME,
			                               D.TERMINAL_ONLYCODE,
			                               D.CUSTOMERID,
			                               SUM(D.TRANSACOUNT) AS   sumAmt
			                          FROM TB_HIS_QT1TBLDEAL D
			                         INNER JOIN TABLE(QUERY_AGENCY.PRODFUNC(#curAgencyId#)) MAT
			                            ON MAT.AGENCY_ID = D.AGENCYID
			                         INNER JOIN QT1TBLTERMINAL T2
			                            ON D.TERMINAL_ONLYCODE = T2.TERMINALCODE
			                           AND T2.AGENCYID = MAT.AGENCY_ID
			                         WHERE  D.CUSTOMERID IS NOT NULL
							<isNotEmpty property="startDate">
										AND D.DEAL_DATA>= TO_DATE(#startDate#, 'YYYYMMDD')
							 </isNotEmpty>
							 <isNotEmpty property="endDate">
								<![CDATA[ AND D.DEAL_DATA<=TO_DATE(#endDate#, 'YYYYMMDD') ]]>
							 </isNotEmpty>
							 <isNotEmpty property="agencyId">
								  AND MAT.PARENTAGENCYID = #agencyId#
							 </isNotEmpty>
							 <isNotEmpty property="startCode">
								<![CDATA[ AND   D.TERMINAL_ONLYCODE >= #startCode#]]>
							 </isNotEmpty>
							 <isNotEmpty property="endCode">
								<![CDATA[ AND  D.TERMINAL_ONLYCODE <= #endCode# ]]>
							 </isNotEmpty>
							 <isNotEmpty property="agencyName">
										  AND MAT.PARENTCOMPANYNAME LIKE '%$agencyName$%'
							 </isNotEmpty>
							 <isNotEmpty property="customerId">
							              AND D.CUSTOMERID  = #customerId#
				             </isNotEmpty>
			                           AND NOT EXISTS
			                         (SELECT 1
			                                  FROM TB_HIS_QT1TBLDEAL HD
			                                 WHERE D.CUSTOMERID = HD.CUSTOMERID 
			                                  <![CDATA[   AND HD.DEAL_DATA <  TO_DATE( #startDate# , 'YYYYMMDD') ]]> )
			                             AND NOT EXISTS
			                         (SELECT 1
			                                  FROM TB_HIS_QT1TBLDEAL HD
			                                 WHERE 
			                                       D.TERMINAL_ONLYCODE = HD.TERMINAL_ONLYCODE
			                                  <![CDATA[   AND HD.DEAL_DATA <  TO_DATE( #startDate# , 'YYYYMMDD') ]]> )
			                           AND D.DEALTYPE_ID IN ($dealTypeId$)
			                           AND NOT EXISTS
			                         (SELECT 1
			                                  FROM TB_PAY_TERM_JNLS TJ
			                                 WHERE  TJ.TERMINALCODE = D.TERMINAL_ONLYCODE  
			                                   AND TJ.AGENCYID = MAT.PARENTAGENCYID
			                                 <![CDATA[    AND TJ.AGENCYID <> #curAgencyId# ]]>)
			                              AND NOT EXISTS
			                         (SELECT 1
			                                  FROM TB_PAY_TERM_JNLS TJ
			                                 WHERE 
			                                       TJ.CUSTOMERID = D.CUSTOMERID 
			                                   AND TJ.AGENCYID = MAT.PARENTAGENCYID
			                                 <![CDATA[    AND TJ.AGENCYID <> #curAgencyId# ]]>)
						 <isNotEmpty property="startDate">
							   <![CDATA[ AND   T2.OPENDATE >=#startDate#]]>
						 </isNotEmpty>
						 <isNotEmpty property="endDate">
			                   <![CDATA[ AND  T2.OPENDATE <=#endDate# ]]>
						 </isNotEmpty>
			                         GROUP BY D.AGENCYID,
			                                  D.TERMINAL_ONLYCODE,
			                                  D.CUSTOMERID,
			                                  MAT.PARENTAGENCYID,
			                                  MAT.PARENTCOMPANYNAME) TT1
			                 INNER JOIN (SELECT TT.TERMINAL_ONLYCODE,
			                                   TT.CUSTOMERID,
			                                   MIN(RN) RN
			                              FROM (SELECT D.TERMINAL_ONLYCODE,
			                                           D.CUSTOMERID,
			                                           ROW_NUMBER() OVER(PARTITION BY D.CUSTOMERID ORDER BY D.DEAL_DATA, D.DEAL_TIME) RN
			                                      FROM TB_HIS_QT1TBLDEAL D
			                                     INNER JOIN TABLE(QUERY_AGENCY.PRODFUNC(#curAgencyId#)) MAT
			                                        ON MAT.AGENCY_ID = D.AGENCYID
			                                     WHERE   D.CUSTOMERID IS NOT NULL
									  <isNotEmpty property="startDate">
												   AND D.DEAL_DATA>= TO_DATE(#startDate#, 'YYYYMMDD')
									 </isNotEmpty>
									 <isNotEmpty property="endDate">
										 <![CDATA[ AND D.DEAL_DATA<=TO_DATE(#endDate#, 'YYYYMMDD') ]]>
									 </isNotEmpty>
									 <isNotEmpty property="agencyId">
												   AND MAT.PARENTAGENCYID = #agencyId#
									 </isNotEmpty>
									 <isNotEmpty property="agencyName">
										  AND MAT.PARENTCOMPANYNAME LIKE '%$agencyName$%'
									 </isNotEmpty>
									  <isNotEmpty property="customerId">
									              AND D.CUSTOMERID  = #customerId#
						             </isNotEmpty>
						             <isNotEmpty property="startCode">
										<![CDATA[ AND   D.TERMINAL_ONLYCODE >= #startCode#]]>
									 </isNotEmpty>
									 <isNotEmpty property="endCode">
										<![CDATA[ AND  D.TERMINAL_ONLYCODE <= #endCode# ]]>
									 </isNotEmpty>
			                                     
			                                       AND NOT EXISTS (SELECT 1
			                                              FROM TB_HIS_QT1TBLDEAL HD
			                                             WHERE D.CUSTOMERID = HD.CUSTOMERID 
															  
			                                        <![CDATA[  AND HD.DEAL_DATA < TO_DATE(#startDate#, 'YYYYMMDD') ]]>)
			                                          AND NOT EXISTS (SELECT 1
			                                              FROM TB_HIS_QT1TBLDEAL HD
			                                             WHERE   D.TERMINAL_ONLYCODE = HD.TERMINAL_ONLYCODE
			                                        <![CDATA[  AND HD.DEAL_DATA < TO_DATE(#startDate#, 'YYYYMMDD') ]]>)
			                                       AND NOT EXISTS
			                                     (SELECT 1
			                                              FROM TB_PAY_TERM_JNLS TJ
			                                             WHERE  TJ.TERMINALCODE = D.TERMINAL_ONLYCODE  
			                                               AND TJ.AGENCYID =  MAT.PARENTAGENCYID
			                                         <![CDATA[ AND TJ.AGENCYID <> #curAgencyId# ]]>)
			                                         AND NOT EXISTS
			                                     (SELECT 1
			                                              FROM TB_PAY_TERM_JNLS TJ
			                                             WHERE  TJ.CUSTOMERID = D.CUSTOMERID
			                                               AND TJ.AGENCYID =  MAT.PARENTAGENCYID
			                                         <![CDATA[ AND TJ.AGENCYID <> #curAgencyId# ]]>)
			                                       AND D.DEALTYPE_ID IN ($dealTypeId$)) TT
			                             GROUP BY TT.TERMINAL_ONLYCODE, TT.CUSTOMERID) TT2
			                    ON TT1.TERMINAL_ONLYCODE = TT2.TERMINAL_ONLYCODE
							 WHERE   1=1
			 			 <isNotEmpty property="activateStandard">
					       <![CDATA[ AND  tt1.sumAmt >=#activateStandard# ]]>
					    </isNotEmpty>
			                 GROUP BY TT1.PARENTAGENCYID,
			                          TT1.PARENTCOMPANYNAME,
			                          TT1.CUSTOMERID,
			                          TT1.TERMINAL_ONLYCODE,
			                          TT1.sumAmt,
			                          TT2.RN
			                 ORDER BY TT1.PARENTAGENCYID,
			                          TT1.CUSTOMERID,
			                          TT1.TERMINAL_ONLYCODE) A) B
			 WHERE RN >  #start#
			   AND RN  <![CDATA[<=]]> #end#
	</select>
	 <insert id="insertOldTermDeal"  parameterClass="TerminalDealBean" >
	     INSERT INTO TB_PAY_TERM_JNLS
				(ID,
				 STARTDATE,
				 ENDDATE,
				 AGENCYID,
				 TERMINALCODE,
				 FLAGSTATUS,
			 	 FLAGOPERTIME,
			 	 FLAGOPERATOR,
			 	 STANDARDDATE,
			     STANDARDAMOUNT,
			     CUSTOMERID)
			SELECT SEQ_TERM_JNLS.NEXTVAL, B.*
				FROM (  
						SELECT #startDate# AS STARTDATE,
						       #endDate# AS ENDDATE,
						       AGENCY_ID,
						       TERMINAL_ID,
						       '1',
						       TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') AS TIME,
						       #flagOperator#,
						       to_char(minDate,'yyyymmdd'),
						       #activateStandard#,
						       CUSTOMERID
						  FROM (SELECT DD.AGENCY_ID,DD.CUSTOMERID, DD.TERMINAL_ID, MIN(DD.DEAL_DATA) as minDate
						          FROM (SELECT MAT.PARENTAGENCYID AS AGENCY_ID,
						          			   D.CUSTOMERID,
						                       D.TERMINAL_ONLYCODE AS TERMINAL_ID,
						                       D.DEAL_DATA,
						                       SUM(D.TRANSACOUNT) OVER(ORDER BY D.DEAL_DATA, D.DEAL_TIME ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS SUMM
						                  FROM TABLE(QUERY_AGENCY.PRODFUNC(#curAgencyId#)) MAT
						                 INNER JOIN TB_HIS_QT1TBLDEAL D
						                    ON MAT.AGENCY_ID = D.AGENCYID
						                 WHERE 	D.CUSTOMERID IS NOT NULL
						                 	 AND NOT EXISTS
									                   ( SELECT 1
							                            FROM TB_PAY_TERM_JNLS TJ
							                            INNER JOIN (SELECT TA.AGENCY_ID
									                                 FROM rtb_qt1tblagency TA
									                                WHERE TA.ONLINECHANNEL = #curAgencyId# 
									                             ) TT
									                       ON TJ.AGENCYID = TT.AGENCY_ID
							                           WHERE TJ.TERMINALCODE =  D.TERMINAL_ONLYCODE  )
						                        <isNotEmpty property="agencyId">
									                AND MAT.PARENTAGENCYID = #agencyId#
									             </isNotEmpty>
									         	 <isNotEmpty property="dealTypeId">
													AND D.DEALTYPE_ID IN ($dealTypeId$)
											     </isNotEmpty>
									             <isNotEmpty property="startDate">
													AND D.DEAL_DATA>= TO_DATE(#startDate#, 'YYYYMMDD')
												 </isNotEmpty>
												 <isNotEmpty property="endDate">
								                    <![CDATA[ AND D.DEAL_DATA<=TO_DATE(#endDate#, 'YYYYMMDD') ]]>
												 </isNotEmpty>
								                 <![CDATA[    AND  D.TERMINAL_ONLYCODE IN  ($terminalCodeStr$) ]]>
								                  <isNotEmpty property="customerId">
														       AND D.CUSTOMERID  = #customerId#
											       </isNotEmpty>
								                 ) DD
						         WHERE SUMM > #activateStandard# 
						         GROUP BY DD.AGENCY_ID, DD.CUSTOMERID,DD.TERMINAL_ID)
						) B
    </insert>
    
</sqlMap>
